<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Free | The Future of Salon Booking</title>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Firebase SDKs (Compat for HTML file usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['Space Grotesk', 'monospace'],
                    },
                    colors: {
                        brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' },
                        dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s infinite',
                        'music': 'music 1s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        music: { '0%': { height: '10%' }, '100%': { height: '100%' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .ticket-notch { width: 24px; height: 24px; background: #f8fafc; border-radius: 50%; position: absolute; bottom: 98px; z-index: 10; }
        .dark .ticket-notch { background: #020617; }
        .notch-l { left: -12px; } .notch-r { right: -12px; }
        
        .scratch-container { position: relative; width: 100%; height: 160px; border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .scratch-canvas { position: absolute; top: 0; left: 0; z-index: 20; cursor: crosshair; touch-action: none; width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-950 text-slate-900 dark:text-slate-50 font-sans antialiased selection:bg-brand-500 selection:text-white transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useMemo, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYJq8T7hMP3OsZ0PYqkWe-dDCWB8_b0Ck",
            authDomain: "line-free-4bb96.firebaseapp.com",
            projectId: "line-free-4bb96",
            storageBucket: "line-free-4bb96.firebasestorage.app",
            messagingSenderId: "137966607796",
            appId: "1:137966607796:web:bc84b4884650911d9ea6e1",
            measurementId: "G-6Z6YQ8Z6CC"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // --- UTILS & DATA GENERATION ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const CITIES = ["Mumbai", "Delhi", "Bangalore", "Hyderabad", "Pune", "Patna", "Lucknow", "Jaipur"];
        const PREFIXES = ["Royal", "Elite", "Urban", "Desi", "Glamour", "Velvet", "Aura", "Pure", "LineFree"];
        const SUFFIXES = ["Studio", "Salon", "Cuts", "Makeover", "Hub", "Lounge", "Barbershop", "Spa"];
        
        // Pollinations AI Helper
        const pollImage = (prompt) => `https://pollinations.ai/p/${encodeURIComponent(prompt)}?width=800&height=600&seed=${Math.floor(Math.random()*100)}`;
        
        const generateSalons = (count = 50) => {
            return Array.from({ length: count }, (_, i) => ({
                id: `s_${i}`,
                name: `${PREFIXES[i % PREFIXES.length]} ${SUFFIXES[i % SUFFIXES.length]} ${Math.floor(Math.random()*99)}`,
                location: `${CITIES[i % CITIES.length]}`,
                rating: (3.5 + Math.random() * 1.5).toFixed(1),
                reviews: Math.floor(Math.random() * 500) + 10,
                isOpen: Math.random() > 0.2,
                image: pollImage(`luxury salon interior design ${i}`),
                queueLength: Math.floor(Math.random() * 8),
                category: i % 3 === 0 ? "Men" : (i % 3 === 1 ? "Women" : "Unisex"),
                services: [
                    { id: 'srv1', name: 'Haircut', price: 300 + Math.floor(Math.random()*200), duration: 30 },
                    { id: 'srv2', name: 'Shave', price: 150 + Math.floor(Math.random()*100), duration: 20 },
                    { id: 'srv3', name: 'Facial', price: 1200 + Math.floor(Math.random()*500), duration: 45 },
                    { id: 'srv4', name: 'Hair Color', price: 2000 + Math.floor(Math.random()*1000), duration: 90 }
                ],
                staff: [
                    { id: 'st1', name: 'Rahul', role: 'Top Stylist', img: `https://api.dicebear.com/7.x/avataaars/svg?seed=Rahul${i}` },
                    { id: 'st2', name: 'Simran', role: 'Colorist', img: `https://api.dicebear.com/7.x/avataaars/svg?seed=Simran${i}` }
                ]
            }));
        };

        const MOCK_INVENTORY = [
            { id: 'inv1', name: "L'Oreal Matrix 5N", sku: "LOR-5N", stock: 8, par: 5, category: "Color" },
            { id: 'inv2', name: "Wella 20Vol Dev", sku: "WEL-20V", stock: 3, par: 6, category: "Developer" },
            { id: 'inv3', name: "Gillette Foam", sku: "GIL-FM", stock: 20, par: 10, category: "Shave" },
            { id: 'inv4', name: "Disposable Towel", sku: "DSP-TW", stock: 150, par: 50, category: "Supplies" }
        ];

        const MOCK_CLIENTS = [
            { id: 'c1', name: "Vikram Malhotra", phone: "9876543210", visits: 14, loyalty: 520, lastVisit: "2023-11-01", notes: "Allergic to Latex", history: ["Haircut", "Beard Trim"] },
            { id: 'c2', name: "Anjali Gupta", phone: "9988776655", visits: 5, loyalty: 150, lastVisit: "2023-10-20", notes: "Likes tea with sugar", history: ["Facial", "Manicure"] }
        ];

        // --- CONTEXT ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('lf_user')) || null);
            const [salons, setSalons] = useState(generateSalons(50));
            const [myTokens, setMyTokens] = useState(JSON.parse(localStorage.getItem('lf_tokens')) || []);
            const [favorites, setFavorites] = useState(JSON.parse(localStorage.getItem('lf_favs')) || []);
            const [darkMode, setDarkMode] = useState(JSON.parse(localStorage.getItem('lf_dark')) || false);
            const [inventory, setInventory] = useState(MOCK_INVENTORY);
            const [clients, setClients] = useState(MOCK_CLIENTS);
            const [notifications, setNotifications] = useState([]);
            const [musicPlaying, setMusicPlaying] = useState(false);
            const [points, setPoints] = useState(120);
            
            const audioRef = useRef(new Audio("https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"));

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                localStorage.setItem('lf_dark', JSON.stringify(darkMode));
            }, [darkMode]);

            useEffect(() => {
                if(user) localStorage.setItem('lf_user', JSON.stringify(user));
                else localStorage.removeItem('lf_user');
            }, [user]);

            useEffect(() => {
                localStorage.setItem('lf_tokens', JSON.stringify(myTokens));
                localStorage.setItem('lf_favs', JSON.stringify(favorites));
            }, [myTokens, favorites]);

            useEffect(() => {
                audioRef.current.loop = true;
                audioRef.current.volume = 0.5;
                if(musicPlaying) audioRef.current.play().catch(() => {});
                else audioRef.current.pause();
            }, [musicPlaying]);

            const notify = (msg, type = 'info') => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 4000);
            };

            const googleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const res = await auth.signInWithPopup(provider);
                    return {
                        name: res.user.displayName,
                        email: res.user.email,
                        photo: res.user.photoURL,
                        uid: res.user.uid
                    };
                } catch (e) {
                    notify(e.message, "error");
                    return null;
                }
            };

            const logout = async () => {
                await auth.signOut();
                setUser(null);
                setMusicPlaying(false);
            };

            // Pollinations AI Wrapper
            const askAI = async (prompt) => {
                try {
                    // Using text.pollinations.ai endpoint
                    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                    if (!res.ok) throw new Error("AI Busy");
                    return await res.text();
                } catch (e) {
                    return "AI is currently offline. Please try again.";
                }
            };

            return (
                <AppContext.Provider value={{
                    user, setUser, logout, googleLogin,
                    salons, myTokens, setMyTokens,
                    favorites, setFavorites,
                    darkMode, setDarkMode,
                    inventory, setInventory,
                    clients, setClients,
                    notify, notifications,
                    musicPlaying, setMusicPlaying,
                    askAI, points, setPoints
                }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- COMPONENTS ---

        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const iconName = name.replace(/-([a-z])/g, g => g[1].toUpperCase());
                    const LucideIcon = window.lucide.icons[iconName.charAt(0).toUpperCase() + iconName.slice(1)];
                    if (LucideIcon) {
                        const svg = window.lucide.createElement(LucideIcon);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', className);
                        ref.current.innerHTML = '';
                        ref.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        const ToastContainer = () => {
            const { notifications } = useContext(AppContext);
            return (
                <div className="fixed top-4 left-0 right-0 z-[60] flex flex-col items-center gap-2 pointer-events-none">
                    <AnimatePresence>
                        {notifications.map(n => (
                            <motion.div key={n.id} initial={{y:-20, opacity:0}} animate={{y:0, opacity:1}} exit={{opacity:0}} className={`px-4 py-2 rounded-full shadow-lg text-white text-sm font-bold flex items-center gap-2 backdrop-blur-md ${n.type==='error'?'bg-red-500/90':n.type==='success'?'bg-green-500/90':'bg-slate-800/90'}`}>
                                <Icon name={n.type==='error'?'alert-circle':n.type==='success'?'check-circle':'bell'} size={16} /> {n.msg}
                            </motion.div>
                        ))}
                    </AnimatePresence>
                </div>
            );
        };

        const Button = ({ children, onClick, variant="primary", className="", loading }) => {
            const base = "w-full py-3.5 rounded-xl font-bold flex items-center justify-center transition-all active:scale-95 disabled:opacity-50";
            const variants = {
                primary: "bg-brand-600 text-white shadow-lg shadow-brand-500/30 hover:bg-brand-700",
                secondary: "bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white hover:bg-slate-200 dark:hover:bg-slate-700",
                danger: "bg-red-50 dark:bg-red-900/20 text-red-500 border border-red-200 dark:border-red-800",
                ai: "bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg shadow-indigo-500/30"
            };
            return (
                <button onClick={onClick} disabled={loading} className={`${base} ${variants[variant]} ${className}`}>
                    {loading ? <Icon name="loader-2" className="animate-spin" /> : children}
                </button>
            );
        };

        // --- BARBER FEATURES ---

        const InventorySystem = () => {
            const { inventory, setInventory, notify } = useContext(AppContext);
            const updateStock = (id, delta) => {
                setInventory(prev => prev.map(i => {
                    if(i.id === id) {
                        const newStock = Math.max(0, i.stock + delta);
                        if(newStock <= i.par) notify(`Low Stock: ${i.name}`, 'warning');
                        return {...i, stock: newStock};
                    }
                    return i;
                }));
            };
            return (
                <div className="space-y-4 p-4">
                    <h2 className="text-2xl font-display font-bold dark:text-white">Inventory & Back-Bar</h2>
                    <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden">
                        {inventory.map((item, idx) => (
                            <div key={item.id} className={`p-4 flex justify-between items-center ${idx!==inventory.length-1?'border-b border-slate-100 dark:border-slate-800':''}`}>
                                <div>
                                    <h4 className="font-bold dark:text-white">{item.name}</h4>
                                    <p className="text-xs text-slate-500">{item.sku} • Par: {item.par}</p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className={`text-xs font-bold px-2 py-1 rounded ${item.stock <= item.par ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{item.stock} left</span>
                                    <div className="flex gap-1">
                                        <button onClick={()=>updateStock(item.id, -1)} className="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-white hover:bg-slate-200">-</button>
                                        <button onClick={()=>updateStock(item.id, 1)} className="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-white hover:bg-slate-200">+</button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const POS = () => {
            const { notify } = useContext(AppContext);
            const [total, setTotal] = useState('');
            
            const handleTxn = () => {
                if(!total) return;
                notify(`Transaction of ₹${total} Successful!`, 'success');
                setTotal('');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            };

            return (
                <div className="p-4 space-y-6">
                    <h2 className="text-2xl font-display font-bold dark:text-white">Point of Sale</h2>
                    <div className="bg-white dark:bg-dark-800 p-6 rounded-3xl shadow-lg border border-slate-100 dark:border-slate-800">
                        <label className="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Amount</label>
                        <div className="flex items-center mt-2 mb-6">
                            <span className="text-3xl font-bold text-slate-400 mr-2">₹</span>
                            <input type="number" value={total} onChange={e=>setTotal(e.target.value)} className="w-full bg-transparent text-4xl font-bold dark:text-white focus:outline-none placeholder-slate-200" placeholder="0" />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <Button onClick={handleTxn} variant="secondary">Cash</Button>
                            <Button onClick={handleTxn}>UPI / Online</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const BarberDash = () => {
            const { user, logout, setMusicPlaying, musicPlaying, askAI } = useContext(AppContext);
            const [view, setView] = useState('dashboard');
            const [queue, setQueue] = useState([{id:1, name:'Amit', srv:'Haircut', token:5}, {id:2, name:'Raj', srv:'Shave', token:6}]);
            const [aiInput, setAiInput] = useState('');
            const [aiRes, setAiRes] = useState('');
            const [loadingAI, setLoadingAI] = useState(false);

            const next = () => {
                setQueue(prev => prev.slice(1));
            };

            const generateAd = async () => {
                if(!aiInput) return;
                setLoadingAI(true);
                const res = await askAI(`Write a short, catchy sms offer for a salon about: ${aiInput}. Include emojis.`);
                setAiRes(res);
                setLoadingAI(false);
            };

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-dark-950 flex flex-col md:flex-row">
                    {/* Sidebar */}
                    <div className="w-full md:w-64 bg-slate-900 text-white p-6 flex flex-col justify-between z-20">
                        <div>
                            <div className="flex items-center gap-2 mb-10"><Icon name="scissors" className="text-brand-500" /> <span className="font-display font-bold text-xl">Line Free</span></div>
                            <nav className="space-y-2">
                                {['dashboard', 'inventory', 'clients', 'pos', 'marketing'].map(v => (
                                    <button key={v} onClick={()=>setView(v)} className={`w-full text-left p-3 rounded-xl flex items-center gap-3 capitalize ${view===v ? 'bg-brand-600' : 'hover:bg-slate-800 text-slate-400'}`}>
                                        <Icon name={v==='dashboard'?'layout-grid':v==='inventory'?'package':v==='clients'?'users':v==='pos'?'credit-card':'sparkles'} size={18} /> {v}
                                    </button>
                                ))}
                            </nav>
                        </div>
                        <div className="space-y-3">
                            <button onClick={()=>setMusicPlaying(!musicPlaying)} className={`w-full p-3 rounded-xl flex items-center gap-3 ${musicPlaying ? 'bg-green-900/50 text-green-400' : 'bg-slate-800 text-slate-400'}`}>
                                <Icon name={musicPlaying?'volume-2':'volume-x'} /> <span className="text-sm font-bold">Lo-Fi Radio</span>
                            </button>
                            <button onClick={logout} className="w-full p-3 rounded-xl flex items-center gap-3 hover:bg-red-900/20 text-red-400"><Icon name="log-out" /> Logout</button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 overflow-y-auto relative h-screen">
                        {view === 'dashboard' && (
                            <div className="p-6">
                                <h1 className="text-3xl font-display font-bold dark:text-white mb-6">Dashboard</h1>
                                <div className="grid grid-cols-2 gap-4 mb-8">
                                    <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800">
                                        <p className="text-xs font-bold text-slate-400 uppercase">Today's Revenue</p>
                                        <p className="text-3xl font-bold text-green-600 mt-1">₹8,450</p>
                                    </div>
                                    <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800">
                                        <p className="text-xs font-bold text-slate-400 uppercase">Active Clients</p>
                                        <p className="text-3xl font-bold text-blue-600 mt-1">{queue.length}</p>
                                    </div>
                                </div>
                                
                                <div className="bg-white dark:bg-dark-800 p-8 rounded-3xl shadow-lg border-t-4 border-brand-500 text-center mb-6">
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">NOW SERVING</p>
                                    {queue.length > 0 ? (
                                        <motion.div key={queue[0].id} initial={{scale:0.9}} animate={{scale:1}}>
                                            <h2 className="text-6xl font-bold text-slate-800 dark:text-white">#{queue[0].token}</h2>
                                            <p className="text-xl font-bold text-brand-600 mt-2">{queue[0].name}</p>
                                            <p className="text-sm text-slate-500">{queue[0].srv}</p>
                                            <Button onClick={next} className="mt-6">Complete & Next</Button>
                                        </motion.div>
                                    ) : (
                                        <div className="py-8 text-slate-400">Queue is empty</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'inventory' && <InventorySystem />}
                        {view === 'pos' && <POS />}
                        
                        {view === 'clients' && (
                            <div className="p-4 space-y-4">
                                <h2 className="text-2xl font-bold dark:text-white">Client Dossiers</h2>
                                {useContext(AppContext).clients.map(c => (
                                    <div key={c.id} className="bg-white dark:bg-dark-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
                                        <div className="flex justify-between">
                                            <h3 className="font-bold dark:text-white">{c.name}</h3>
                                            <span className="text-xs bg-brand-100 text-brand-700 px-2 py-1 rounded-full">{c.loyalty} Pts</span>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-1">{c.phone} • Last Visit: {c.lastVisit}</p>
                                        <div className="mt-3 p-3 bg-red-50 dark:bg-red-900/10 rounded-lg text-xs font-medium text-red-600 dark:text-red-400">
                                            ⚠️ {c.notes}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'marketing' && (
                            <div className="p-6">
                                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <h2 className="text-2xl font-bold mb-2 flex items-center gap-2"><Icon name="sparkles" /> AI Marketing</h2>
                                        <p className="opacity-80 mb-6 text-sm">Generate copy for SMS/Instagram instantly.</p>
                                        <input value={aiInput} onChange={e=>setAiInput(e.target.value)} className="w-full bg-white/20 border border-white/20 rounded-xl p-3 text-white placeholder-white/50 focus:outline-none focus:bg-white/30" placeholder="e.g. 50% off for students this weekend" />
                                        <button onClick={generateAd} disabled={loadingAI} className="mt-4 w-full bg-white text-indigo-700 py-3 rounded-xl font-bold shadow-lg disabled:opacity-50">
                                            {loadingAI ? 'Generating...' : 'Create Magic'}
                                        </button>
                                        {aiRes && <div className="mt-6 bg-black/30 p-4 rounded-xl font-mono text-sm border border-white/10">{aiRes}</div>}
                                    </div>
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/30 rounded-full blur-3xl -mr-10 -mt-10"></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- CUSTOMER FEATURES ---

        const ScratchModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-dark-800 p-6 rounded-3xl w-full max-w-sm relative">
                        <button onClick={onClose} className="absolute -top-4 -right-4 bg-white rounded-full p-2 text-black"><Icon name="x" /></button>
                        <h3 className="text-center font-bold text-xl mb-4 dark:text-white">Scratch & Win!</h3>
                        <div className="scratch-container bg-slate-200">
                            {/* Canvas logic would go here, simplistic for now */}
                            <div className="absolute inset-0 flex items-center justify-center bg-brand-500 text-white font-bold text-2xl">
                                20% OFF
                            </div>
                            <div className="absolute inset-0 bg-slate-400 flex items-center justify-center text-slate-100 font-bold text-lg cursor-pointer hover:opacity-0 transition-opacity duration-700">
                                SCRATCH HERE
                            </div>
                        </div>
                        <p className="text-center text-xs text-slate-400 mt-4">Reveal your prize to add it to your wallet.</p>
                    </div>
                </div>
            );
        };

        const ARMirror = ({ onClose }) => {
            const videoRef = useRef(null);
            
            useEffect(() => {
                navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                    if(videoRef.current) videoRef.current.srcObject = stream;
                }).catch(e => alert("Camera permission denied"));
                return () => {
                    if(videoRef.current && videoRef.current.srcObject) {
                        videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                    }
                }
            }, []);

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col">
                    <div className="relative flex-1 bg-black">
                        <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover transform -scale-x-100"></video>
                        <div className="absolute inset-0 pointer-events-none" style={{background: 'radial-gradient(circle at 50% 30%, rgba(236, 72, 153, 0.3), transparent 50%)', mixBlendMode: 'overlay'}}></div>
                        <button onClick={onClose} className="absolute top-4 left-4 bg-black/50 text-white p-3 rounded-full backdrop-blur"><Icon name="arrow-left" /></button>
                    </div>
                    <div className="h-32 bg-black flex items-center justify-center gap-4 overflow-x-auto p-4">
                        {['#ef4444', '#eab308', '#a855f7', '#3b82f6'].map(c => (
                            <button key={c} className="w-12 h-12 rounded-full border-2 border-white" style={{backgroundColor: c}}></button>
                        ))}
                    </div>
                </div>
            );
        };

        const CustomerDash = () => {
            const { user, salons, addToken, myTokens, setMyTokens, favorites, setFavorites, points, logout, musicPlaying, setMusicPlaying, darkMode, setDarkMode } = useContext(AppContext);
            const [view, setView] = useState('home');
            const [selectedSalon, setSelectedSalon] = useState(null);
            const [cart, setCart] = useState([]);
            const [showScratch, setShowScratch] = useState(false);
            const [showAR, setShowAR] = useState(false);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearch] = useState("");

            const toggleFav = (id) => setFavorites(prev => prev.includes(id) ? prev.filter(f=>f!==id) : [...prev, id]);

            const book = () => {
                setLoading(true);
                setTimeout(() => {
                    addToken(selectedSalon, cart);
                    setLoading(false);
                    setCart([]);
                    setView('tokens');
                }, 1500);
            };

            if (showAR) return <ARMirror onClose={()=>setShowAR(false)} />;

            if (selectedSalon && view === 'salon') {
                return (
                    <div className="bg-white dark:bg-dark-900 min-h-screen pb-24">
                        <div className="relative h-64">
                            <img src={selectedSalon.image} className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <button onClick={()=>setView('home')} className="absolute top-4 left-4 bg-white/20 backdrop-blur p-2 rounded-full text-white"><Icon name="arrow-left"/></button>
                            <button onClick={()=>toggleFav(selectedSalon.id)} className="absolute top-4 right-4 bg-white/20 backdrop-blur p-2 rounded-full text-white">
                                <Icon name="heart" className={favorites.includes(selectedSalon.id)?'fill-red-500 text-red-500':''} />
                            </button>
                            <div className="absolute bottom-4 left-4 right-4 text-white">
                                <h2 className="text-3xl font-display font-bold">{selectedSalon.name}</h2>
                                <p className="opacity-90 text-sm flex items-center gap-2"><Icon name="map-pin" size={14}/> {selectedSalon.location} • <Icon name="star" size={14} className="fill-gold-500 text-gold-500"/> {selectedSalon.rating}</p>
                            </div>
                        </div>
                        <div className="p-5">
                            <div className="flex gap-3 mb-6">
                                <div className="flex-1 bg-slate-50 dark:bg-dark-800 p-3 rounded-xl text-center border border-slate-100 dark:border-slate-800">
                                    <p className="text-xs text-slate-400 font-bold uppercase">Queue</p>
                                    <p className="text-xl font-bold dark:text-white">{selectedSalon.queueLength} Ppl</p>
                                </div>
                                <div className="flex-1 bg-slate-50 dark:bg-dark-800 p-3 rounded-xl text-center border border-slate-100 dark:border-slate-800">
                                    <p className="text-xs text-slate-400 font-bold uppercase">Wait</p>
                                    <p className="text-xl font-bold text-brand-600">~{selectedSalon.queueLength * 15} min</p>
                                </div>
                            </div>
                            
                            <h3 className="font-bold text-lg mb-3 dark:text-white">Services</h3>
                            <div className="space-y-3">
                                {selectedSalon.services.map(s => {
                                    const inCart = cart.find(x => x.id === s.id);
                                    return (
                                        <div key={s.id} onClick={()=>{inCart?setCart(cart.filter(x=>x.id!==s.id)):setCart([...cart,s])}} className={`p-4 rounded-xl border flex justify-between items-center cursor-pointer transition-all ${inCart ? 'border-brand-500 bg-brand-50 dark:bg-brand-900/20' : 'border-slate-200 dark:border-slate-800'}`}>
                                            <div><p className="font-bold dark:text-white">{s.name}</p><p className="text-xs text-slate-500">{s.duration} min</p></div>
                                            <div className="flex items-center gap-3">
                                                <p className="font-bold text-brand-600">₹{s.price}</p>
                                                <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${inCart ? 'bg-brand-500 border-brand-500 text-white' : 'border-slate-300'}`}>{inCart && <Icon name="check" size={12}/>}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="fixed bottom-0 w-full p-4 bg-white dark:bg-dark-900 border-t border-slate-100 dark:border-slate-800 z-20">
                            <Button onClick={book} disabled={cart.length===0} loading={loading}>
                                {cart.length>0 ? `Book (${cart.length}) • ₹${cart.reduce((a,b)=>a+b.price,0)}` : 'Select Services'}
                            </Button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-slate-50 dark:bg-dark-950 min-h-screen pb-24 transition-colors duration-300">
                    {/* Header */}
                    <div className="sticky top-0 bg-white/80 dark:bg-dark-900/80 backdrop-blur-md px-5 py-4 z-30 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <img src={user.photo || "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"} className="w-9 h-9 rounded-full border border-slate-200" />
                            <div><p className="text-xs font-bold text-slate-400">HELLO</p><h3 className="font-bold leading-none dark:text-white">{user.name.split(' ')[0]}</h3></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setDarkMode(!darkMode)} className="w-9 h-9 rounded-full bg-slate-100 dark:bg-dark-800 flex items-center justify-center text-slate-600 dark:text-slate-400"><Icon name={darkMode?'sun':'moon'} size={18}/></button>
                            <button onClick={()=>setShowScratch(true)} className="w-9 h-9 rounded-full bg-gradient-to-r from-gold-400 to-gold-600 flex items-center justify-center text-white shadow-lg shadow-gold-500/30 animate-pulse"><Icon name="gift" size={18}/></button>
                        </div>
                    </div>

                    <div className="p-5">
                        {view === 'home' && (
                            <div className="space-y-6">
                                {/* Search */}
                                <div className="relative">
                                    <Icon name="search" className="absolute left-3 top-3 text-slate-400" size={18} />
                                    <input value={searchTerm} onChange={e=>setSearch(e.target.value)} placeholder="Search salons, services..." className="w-full bg-white dark:bg-dark-800 border-none rounded-xl py-3 pl-10 text-sm shadow-sm focus:ring-2 focus:ring-brand-500 dark:text-white" />
                                </div>

                                {/* AR Banner */}
                                <div className="bg-black rounded-2xl overflow-hidden relative h-40 shadow-xl flex items-center cursor-pointer group" onClick={()=>setShowAR(true)}>
                                    <img src="https://images.unsplash.com/photo-1562322140-8baeececf3df?w=800&q=80" className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700" />
                                    <div className="relative z-10 p-6">
                                        <span className="bg-brand-500 text-white text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block">NEW AI FEATURE</span>
                                        <h2 className="text-2xl font-bold text-white mb-1">Virtual Try-On</h2>
                                        <p className="text-white/80 text-xs">Test hair colors before you book.</p>
                                    </div>
                                </div>

                                {/* Salons */}
                                <h3 className="font-bold text-lg dark:text-white">Featured Salons</h3>
                                <div className="space-y-4">
                                    {salons.filter(s => s.name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0, 20).map(s => (
                                        <div key={s.id} onClick={()=>{setSelectedSalon(s); setView('salon')}} className="bg-white dark:bg-dark-800 p-3 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex gap-4 cursor-pointer hover:border-brand-500 transition-colors">
                                            <div className="w-24 h-24 rounded-xl bg-slate-200 overflow-hidden shrink-0"><img src={s.image} className="w-full h-full object-cover" loading="lazy" /></div>
                                            <div className="flex-1 py-1">
                                                <div className="flex justify-between items-start">
                                                    <h4 className="font-bold text-slate-900 dark:text-white leading-tight">{s.name}</h4>
                                                    <span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-slate-500">{s.rating} ★</span>
                                                </div>
                                                <p className="text-xs text-slate-500 mt-1 mb-3">{s.location}</p>
                                                <div className="flex gap-2">
                                                    <span className="text-[10px] font-bold bg-green-50 text-green-600 px-2 py-1 rounded">Wait: ~{s.queueLength * 15}m</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'tokens' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold font-display dark:text-white">My Tokens</h2>
                                {myTokens.length === 0 ? (
                                    <div className="text-center py-20 opacity-50 dark:text-white"><Icon name="ticket" size={48} className="mx-auto mb-2"/><p>No active tokens</p></div>
                                ) : (
                                    myTokens.map(t => (
                                        <div key={t.id} className="bg-white dark:bg-dark-800 rounded-3xl overflow-hidden shadow-lg border border-slate-100 dark:border-slate-800 relative">
                                            <div className="bg-dark-900 p-6 text-white relative">
                                                <h3 className="font-bold text-lg">{t.salonName}</h3>
                                                <p className="text-xs opacity-70">{t.salonLocation}</p>
                                            </div>
                                            <div className="p-6 relative">
                                                <div className="ticket-notch notch-l shadow-inner dark:bg-dark-950"></div>
                                                <div className="ticket-notch notch-r shadow-inner dark:bg-dark-950"></div>
                                                <div className="border-b-2 border-dashed border-slate-200 dark:border-slate-700 pb-6 mb-6 flex justify-between items-center">
                                                    <div className="text-center"><p className="text-xs text-slate-400 font-bold uppercase">Token</p><p className="text-5xl font-display font-bold text-brand-600">#{t.tokenNumber}</p></div>
                                                    <div className="text-right"><p className="text-xs text-slate-400 font-bold uppercase">Est. Time</p><p className="text-2xl font-bold text-slate-800 dark:text-white">{t.estimatedTime}</p></div>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <div><p className="font-bold text-sm dark:text-white">{t.serviceNames}</p><p className="text-xs text-slate-500">₹{t.totalPrice}</p></div>
                                                    <button onClick={()=>{if(confirm('Cancel?')) setMyTokens(myTokens.filter(x=>x.id!==t.id))}} className="text-xs text-red-500 font-bold border border-red-100 px-3 py-1.5 rounded-lg hover:bg-red-50">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {view === 'profile' && (
                            <div className="pt-10 text-center">
                                <div className="w-24 h-24 rounded-full bg-slate-200 mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg"><img src={user.photo || "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"} className="w-full h-full object-cover"/></div>
                                <h2 className="text-2xl font-bold dark:text-white">{user.name}</h2>
                                <p className="text-slate-500 mb-8">{user.email}</p>
                                
                                <div className="grid grid-cols-2 gap-4 mb-8">
                                    <div className="bg-white dark:bg-dark-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800">
                                        <p className="text-xs text-slate-400 font-bold uppercase">Points</p>
                                        <p className="text-2xl font-bold text-gold-500">{points}</p>
                                    </div>
                                    <div className="bg-white dark:bg-dark-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800">
                                        <p className="text-xs text-slate-400 font-bold uppercase">Bookings</p>
                                        <p className="text-2xl font-bold text-brand-600">{myTokens.length}</p>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <button onClick={()=>setMusicPlaying(!musicPlaying)} className={`w-full p-4 rounded-xl flex items-center justify-between ${musicPlaying ? 'bg-green-100 text-green-700' : 'bg-white dark:bg-dark-800 dark:text-white'}`}>
                                        <span className="flex items-center gap-3 font-bold"><Icon name="music" /> Ambience Music</span>
                                        <span className="text-xs font-bold uppercase">{musicPlaying ? 'ON' : 'OFF'}</span>
                                    </button>
                                    <button onClick={logout} className="w-full p-4 rounded-xl bg-red-50 text-red-600 font-bold flex items-center justify-center gap-2 hover:bg-red-100"><Icon name="log-out"/> Logout</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {showScratch && <ScratchModal onClose={()=>setShowScratch(false)} />}

                    {/* Bottom Nav */}
                    <div className="fixed bottom-0 w-full max-w-md bg-white/90 dark:bg-dark-900/90 backdrop-blur border-t border-slate-200 dark:border-slate-800 h-20 flex justify-around items-center z-30 pb-4 left-0 right-0 mx-auto">
                        {['home', 'tokens', 'profile'].map(t => (
                            <button key={t} onClick={()=>setView(t)} className={`flex flex-col items-center gap-1 ${view===t ? 'text-brand-600' : 'text-slate-400'}`}>
                                <Icon name={t==='home'?'home':t==='tokens'?'ticket':'user'} size={24} className={view===t?'fill-current':''} />
                                <span className="text-[10px] font-bold capitalize">{t}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- AUTH FLOW ---
        const Login = () => {
            const { setUser, googleLogin, notify } = useContext(AppContext);
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [temp, setTemp] = useState(null);
            const [phone, setPhone] = useState('');

            const handleGoogle = async () => {
                setLoading(true);
                const data = await googleLogin();
                if(data) {
                    setTemp(data);
                    setStep(2);
                }
                setLoading(false);
            };

            const finalize = (role) => {
                setLoading(true);
                setTimeout(() => {
                    setUser({ ...temp, phone, role });
                    setLoading(false);
                }, 800);
            };

            return (
                <div className="min-h-screen bg-dark-950 flex items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1633681926022-84c23e8cb2d6?w=1600&q=80')] bg-cover bg-center opacity-30"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-dark-950 via-dark-900/90 to-transparent"></div>

                    <motion.div initial={{y:20, opacity:0}} animate={{y:0, opacity:1}} className="relative z-10 w-full max-w-sm bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl text-white">
                        <div className="text-center mb-10">
                            <div className="w-16 h-16 bg-brand-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-brand-500/50">
                                <Icon name="scissors" size={32} />
                            </div>
                            <h1 className="text-4xl font-display font-bold">Line Free</h1>
                            <p className="text-white/60 mt-2">Skip the wait. Style instantly.</p>
                        </div>

                        {step === 1 && (
                            <button onClick={handleGoogle} disabled={loading} className="w-full bg-white text-slate-900 py-4 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-slate-100 transition-colors">
                                {loading ? <Icon name="loader-2" className="animate-spin" /> : (
                                    <>
                                        <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                        Continue with Google
                                    </>
                                )}
                            </button>
                        )}

                        {step === 2 && (
                            <form onSubmit={(e)=>{e.preventDefault(); if(phone.length<10)return; setStep(3)}} className="space-y-4">
                                <div className="bg-white/10 p-4 rounded-xl flex items-center gap-3">
                                    <img src={temp.photo} className="w-10 h-10 rounded-full" />
                                    <div><p className="font-bold text-sm">{temp.name}</p><p className="text-xs text-white/60">{temp.email}</p></div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold uppercase text-brand-300 tracking-wider">Mobile Number</label>
                                    <input type="tel" value={phone} onChange={e=>setPhone(e.target.value)} className="w-full bg-white/5 border border-white/20 rounded-xl mt-2 py-3 px-4 text-white focus:outline-none focus:border-brand-500" placeholder="98765 43210" autoFocus />
                                </div>
                                <Button onClick={()=>{}}>Next <Icon name="arrow-right" size={16} className="ml-2"/></Button>
                            </form>
                        )}

                        {step === 3 && (
                            <div className="space-y-3">
                                <p className="text-center text-sm text-white/60 mb-4">Choose your role</p>
                                <button onClick={()=>finalize('customer')} className="w-full bg-white/5 hover:bg-white/10 border border-white/10 p-4 rounded-xl flex items-center gap-4 transition-colors text-left group">
                                    <div className="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 group-hover:scale-110 transition-transform"><Icon name="user" /></div>
                                    <div><h4 className="font-bold text-lg">Customer</h4><p className="text-xs text-white/50">Book & Explore</p></div>
                                </button>
                                <button onClick={()=>finalize('barber')} className="w-full bg-white/5 hover:bg-white/10 border border-white/10 p-4 rounded-xl flex items-center gap-4 transition-colors text-left group">
                                    <div className="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 group-hover:scale-110 transition-transform"><Icon name="scissors" /></div>
                                    <div><h4 className="font-bold text-lg">Salon Owner</h4><p className="text-xs text-white/50">Manage Business</p></div>
                                </button>
                            </div>
                        )}
                        {loading && <div className="absolute inset-0 bg-dark-950/80 flex items-center justify-center rounded-3xl"><Icon name="loader-2" className="animate-spin text-white" size={32} /></div>}
                    </motion.div>
                </div>
            );
        };

        // --- ROOT ---
        const App = () => {
            const { user } = useContext(AppContext);
            if (!user) return <Login />;
            return user.role === 'barber' ? <BarberDash /> : <CustomerDash />;
        };

        const Root = () => ( <AppProvider> <App /> </AppProvider> );
        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>


