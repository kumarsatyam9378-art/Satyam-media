<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Free | AI Future Salon</title>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['Space Grotesk', 'monospace'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s infinite',
                        'scan': 'scan 2s linear infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%' },
                            '50%': { top: '100%' },
                            '100%': { top: '0%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .ticket-notch { width: 24px; height: 24px; background: #f8fafc; border-radius: 50%; position: absolute; bottom: 98px; z-index: 10; }
        .dark .ticket-notch { background: #020617; }
        .notch-l { left: -12px; } .notch-r { right: -12px; }
        
        /* Dynamic Theme Variables */
        :root { --brand-color: #0d9488; }
        .bg-brand { background-color: var(--brand-color); }
        .text-brand { color: var(--brand-color); }
        .border-brand { border-color: var(--brand-color); }
        
        .scan-line { position: absolute; left: 0; width: 100%; height: 2px; background: #00ff00; box-shadow: 0 0 10px #00ff00; animation: scan 2s linear infinite; z-index: 20; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-950 text-slate-900 dark:text-slate-50 font-sans antialiased selection:bg-brand-500 selection:text-white transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYJq8T7hMP3OsZ0PYqkWe-dDCWB8_b0Ck",
            authDomain: "line-free-4bb96.firebaseapp.com",
            projectId: "line-free-4bb96",
            storageBucket: "line-free-4bb96.firebasestorage.app",
            messagingSenderId: "137966607796",
            appId: "1:137966607796:web:bc84b4884650911d9ea6e1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // --- UTILS & DATA ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const CITIES = ["Mumbai", "Delhi", "Bangalore", "Pune"];
        
        // AI Image Generator Helper (Robust)
        const getAiImage = (prompt) => `https://pollinations.ai/p/${encodeURIComponent(prompt)}?width=800&height=600&seed=${Math.floor(Math.random()*100)}&nologo=true`;

        const generateSalons = (count = 15) => Array.from({ length: count }, (_, i) => ({
            id: `s_${i}`,
            name: `${["Luxe", "Urban", "Vintage", "Cyber"][i%4]} ${["Cuts", "Studio", "Barbers", "Hub"][i%4]} ${i+1}`,
            location: CITIES[i % CITIES.length],
            rating: (3.8 + Math.random() * 1.2).toFixed(1),
            image: getAiImage(`luxury modern salon interior design lighting ${i}`),
            queueLength: Math.floor(Math.random() * 8),
            gender: i % 2 === 0 ? "Men" : "Unisex",
            services: [
                { id: 'srv1', name: 'Haircut', price: 300, duration: 30 },
                { id: 'srv2', name: 'Beard Shape', price: 150, duration: 20 },
                { id: 'srv3', name: 'Hair Color', price: 1200, duration: 60 }
            ]
        }));

        // --- CONTEXT ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('lf_user')) || null);
            const [salons] = useState(generateSalons());
            const [myTokens, setMyTokens] = useState(JSON.parse(localStorage.getItem('lf_tokens')) || []);
            const [darkMode, setDarkMode] = useState(true);
            
            // Customization State
            const [themeColor, setThemeColor] = useState('#0d9488'); // Default Teal
            const [fontStyle, setFontStyle] = useState('sans'); // sans, serif, mono
            const [musicPlaying, setMusicPlaying] = useState(false);
            
            const audioRef = useRef(new Audio("https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"));

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                document.documentElement.style.setProperty('--brand-color', themeColor);
                if(user) localStorage.setItem('lf_user', JSON.stringify(user));
                localStorage.setItem('lf_tokens', JSON.stringify(myTokens));
            }, [darkMode, themeColor, user, myTokens]);

            useEffect(() => {
                audioRef.current.loop = true;
                if(musicPlaying) audioRef.current.play().catch(()=>{});
                else audioRef.current.pause();
            }, [musicPlaying]);

            // --- VOICE ASSISTANT ---
            const speak = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const msg = new SpeechSynthesisUtterance(text);
                    msg.rate = 1.0;
                    msg.pitch = 1.1;
                    window.speechSynthesis.speak(msg);
                }
            };

            const googleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const res = await auth.signInWithPopup(provider);
                    const u = { name: res.user.displayName, email: res.user.email, photo: res.user.photoURL, uid: res.user.uid };
                    speak(`Welcome back, ${u.name.split(' ')[0]}`);
                    return u;
                } catch (e) { alert(e.message); return null; }
            };

            const logout = async () => { await auth.signOut(); setUser(null); };

            const addToken = (salon, services) => {
                const total = services.reduce((a,b)=>a+b.price, 0);
                const wait = services.reduce((a,b)=>a+b.duration,0) + (salon.queueLength * 15);
                const newToken = {
                    id: generateId(),
                    salonName: salon.name,
                    salonLocation: salon.location,
                    tokenNumber: Math.floor(Math.random()*50)+1,
                    estimatedTime: `${wait} min`,
                    totalPrice: total,
                    serviceNames: services.map(s=>s.name).join(', '),
                    date: new Date().toISOString()
                };
                setMyTokens([...myTokens, newToken]);
                speak(`Booking confirmed at ${salon.name}. Your estimated wait is ${wait} minutes.`);
            };

            // AI Text Helper
            const askAI = async (prompt) => {
                try {
                    const res = await fetch(`https://pollinations.ai/api/text?prompt=${encodeURIComponent(prompt)}`);
                    return await res.text();
                } catch(e) { return "System busy."; }
            };

            return (
                <AppContext.Provider value={{
                    user, setUser, logout, googleLogin,
                    salons, myTokens, setMyTokens, addToken,
                    darkMode, setDarkMode,
                    themeColor, setThemeColor,
                    fontStyle, setFontStyle,
                    musicPlaying, setMusicPlaying,
                    speak, askAI, getAiImage
                }}>
                    <div className={`font-${fontStyle}`}>
                        {children}
                    </div>
                </AppContext.Provider>
            );
        };

        // --- COMPONENTS ---
        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const iconName = name.replace(/-([a-z])/g, g => g[1].toUpperCase());
                    const LucideIcon = window.lucide.icons[iconName.charAt(0).toUpperCase() + iconName.slice(1)];
                    if (LucideIcon) {
                        const svg = window.lucide.createElement(LucideIcon);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', className);
                        ref.current.innerHTML = '';
                        ref.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        const BackButton = ({ onClick }) => (
            <button onClick={onClick} className="fixed top-4 left-4 z-50 bg-white/20 backdrop-blur-md border border-white/20 text-white p-3 rounded-full shadow-lg hover:scale-110 transition-transform active:scale-95">
                <Icon name="arrow-left" size={24} />
            </button>
        );

        const Loading = () => (
            <div className="flex items-center justify-center gap-2 py-4">
                <Icon name="loader-2" className="animate-spin text-brand" /> <span className="text-sm opacity-70">Processing...</span>
            </div>
        );

        // --- AI STYLIST (CAMERA FEATURE) ---
        const SmartStylist = ({ onClose }) => {
            const { getAiImage, speak } = useContext(AppContext);
            const [step, setStep] = useState(0); // 0: Gender, 1: Service, 2: Camera, 3: Processing, 4: Result
            const [data, setData] = useState({ gender: '', service: '', img: null });
            const [resultImg, setResultImg] = useState(null);

            const handleNext = (key, val) => {
                setData(prev => ({...prev, [key]: val}));
                setStep(prev => prev + 1);
            };

            const handleCamera = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setData(prev => ({...prev, img: e.target.result}));
                        setStep(3); // Go to processing
                        processAI();
                    };
                    reader.readAsDataURL(file);
                }
            };

            const processAI = () => {
                speak("Scanning face structure. Analyzing best styles for you.");
                setTimeout(() => {
                    const prompt = `Portrait of a ${data.gender} with a modern trendy ${data.service} style, photorealistic, cinematic lighting, 8k, face looking forward`;
                    setResultImg(getAiImage(prompt));
                    setStep(4);
                    speak("Here is a suggested look based on your face shape.");
                }, 3000);
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/95 text-white flex flex-col p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-display font-bold text-brand">AI Smart Stylist</h2>
                        <button onClick={onClose} className="bg-white/10 p-2 rounded-full"><Icon name="x"/></button>
                    </div>

                    <div className="flex-1 flex flex-col justify-center items-center text-center">
                        {step === 0 && (
                            <motion.div initial={{opacity:0, y:20}} animate={{opacity:1, y:0}} className="space-y-6 w-full max-w-sm">
                                <h3 className="text-xl">Are you...?</h3>
                                <button onClick={()=>handleNext('gender', 'Male')} className="w-full p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-brand hover:bg-slate-700 transition-all flex items-center gap-4">
                                    <Icon name="user" size={32} className="text-blue-400"/> <span className="text-lg font-bold">Male</span>
                                </button>
                                <button onClick={()=>handleNext('gender', 'Female')} className="w-full p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-brand hover:bg-slate-700 transition-all flex items-center gap-4">
                                    <Icon name="user" size={32} className="text-pink-400"/> <span className="text-lg font-bold">Female</span>
                                </button>
                            </motion.div>
                        )}

                        {step === 1 && (
                            <motion.div initial={{opacity:0, y:20}} animate={{opacity:1, y:0}} className="space-y-6 w-full max-w-sm">
                                <h3 className="text-xl">What are you looking for?</h3>
                                {['Haircut', 'Beard Styling', 'Hair Color', 'Complete Makeover'].map(s => (
                                    <button key={s} onClick={()=>handleNext('service', s)} className="w-full p-4 bg-slate-800 rounded-xl border border-slate-700 hover:bg-brand hover:text-white font-bold">
                                        {s}
                                    </button>
                                ))}
                            </motion.div>
                        )}

                        {step === 2 && (
                            <motion.div initial={{opacity:0}} animate={{opacity:1}} className="w-full max-w-sm">
                                <h3 className="text-xl mb-6">Let's see your face</h3>
                                <div className="relative w-full aspect-square bg-slate-800 rounded-3xl border-2 border-dashed border-slate-600 flex flex-col items-center justify-center overflow-hidden mb-6 group">
                                    <Icon name="camera" size={48} className="text-slate-500 mb-2"/>
                                    <p className="text-slate-400 text-sm">Tap to Open Camera</p>
                                    <input type="file" accept="image/*" capture="user" onChange={handleCamera} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                            </motion.div>
                        )}

                        {step === 3 && (
                            <div className="w-full max-w-sm relative rounded-3xl overflow-hidden shadow-2xl">
                                <img src={data.img} className="w-full h-full object-cover opacity-50" />
                                <div className="absolute inset-0 flex flex-col items-center justify-center z-10">
                                    <div className="scan-line"></div>
                                    <div className="bg-black/60 backdrop-blur px-6 py-3 rounded-full border border-green-500/50 flex items-center gap-3">
                                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span className="font-mono text-green-400 text-sm">AI ANALYZING...</span>
                                    </div>
                                    <div className="mt-4 font-mono text-xs text-green-400/70">
                                        > Face Shape Detected<br/>
                                        > Checking Trends...<br/>
                                        > Generating Preview...
                                    </div>
                                </div>
                            </div>
                        )}

                        {step === 4 && (
                            <motion.div initial={{scale:0.9, opacity:0}} animate={{scale:1, opacity:1}} className="w-full max-w-sm space-y-4">
                                <h3 className="text-xl font-bold text-green-400">Match Found!</h3>
                                <div className="relative aspect-[3/4] rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
                                    <img src={resultImg} className="w-full h-full object-cover" />
                                    <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black to-transparent p-4">
                                        <p className="font-bold">Recommended: {data.service}</p>
                                        <p className="text-xs text-slate-300">Based on your face structure</p>
                                    </div>
                                </div>
                                <button onClick={onClose} className="w-full py-4 bg-brand text-white font-bold rounded-xl shadow-lg shadow-brand/20">
                                    Look for Salons
                                </button>
                            </motion.div>
                        )}
                    </div>
                </div>
            );
        };

        // --- CUSTOMER CHATBOT ---
        const ChatBot = ({ onClose }) => {
            const { askAI, speak, salons } = useContext(AppContext);
            const [msgs, setMsgs] = useState([{role:'ai', text:'Hi! I am your AI Stylist. Ask me about best salons or wait times!'}]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [msgs]);

            const send = async () => {
                if(!input.trim()) return;
                const userMsg = input;
                setInput('');
                setMsgs(prev => [...prev, {role:'user', text:userMsg}]);
                setLoading(true);

                // Context for AI
                const context = `You are a helpful Salon Assistant. Available salons: ${salons.map(s=>s.name).join(', ')}. Recommend based on ratings. Keep it short.`;
                const reply = await askAI(`${context} User asked: ${userMsg}`);
                
                setMsgs(prev => [...prev, {role:'ai', text:reply}]);
                speak(reply);
                setLoading(false);
            };

            return (
                <div className="fixed bottom-24 right-4 w-80 h-96 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden z-40">
                    <div className="bg-brand p-4 flex justify-between items-center text-white">
                        <div className="flex items-center gap-2"><Icon name="bot"/> <span>AI Assistant</span></div>
                        <button onClick={onClose}><Icon name="x" size={16}/></button>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 dark:bg-black/20">
                        {msgs.map((m,i) => (
                            <div key={i} className={`p-3 rounded-xl text-sm max-w-[80%] ${m.role==='user'?'ml-auto bg-brand text-white rounded-br-none':'bg-slate-200 dark:bg-slate-800 dark:text-white rounded-bl-none'}`}>
                                {m.text}
                            </div>
                        ))}
                        {loading && <div className="text-xs text-slate-400 ml-2">Typing...</div>}
                    </div>
                    <div className="p-3 border-t border-slate-200 dark:border-slate-800 flex gap-2">
                        <input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} className="flex-1 bg-transparent text-sm outline-none dark:text-white" placeholder="Ask anything..." />
                        <button onClick={send} disabled={loading} className="text-brand disabled:opacity-50"><Icon name="send"/></button>
                    </div>
                </div>
            );
        };

        // --- MAGIC MENU (CUSTOMIZATION) ---
        const MagicMenu = ({ onClose }) => {
            const { themeColor, setThemeColor, fontStyle, setFontStyle, musicPlaying, setMusicPlaying, darkMode, setDarkMode } = useContext(AppContext);
            const colors = ['#0d9488', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'];
            
            return (
                <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                    <motion.div initial={{y:100}} animate={{y:0}} className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-6">
                        <div className="flex justify-between items-center">
                            <h3 className="font-bold text-xl dark:text-white">Magic Customization</h3>
                            <button onClick={onClose} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><Icon name="x"/></button>
                        </div>
                        
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase mb-3">Theme Color</p>
                            <div className="flex gap-3 overflow-x-auto pb-2">
                                {colors.map(c => (
                                    <button key={c} onClick={()=>setThemeColor(c)} className={`w-10 h-10 rounded-full shrink-0 border-2 ${themeColor===c?'border-white shadow-lg scale-110':'border-transparent'}`} style={{background:c}}></button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase mb-3">Font Style</p>
                            <div className="grid grid-cols-3 gap-2">
                                {['sans', 'serif', 'mono'].map(f => (
                                    <button key={f} onClick={()=>setFontStyle(f)} className={`p-2 rounded-lg border text-sm capitalize ${fontStyle===f?'border-brand bg-brand/10 text-brand font-bold':'border-slate-200 dark:border-slate-700 dark:text-white'}`}>
                                        {f}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-3">
                            <button onClick={()=>setMusicPlaying(!musicPlaying)} className={`w-full p-4 rounded-xl flex items-center justify-between ${musicPlaying ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-slate-100 dark:bg-slate-800 dark:text-white'}`}>
                                <span className="flex items-center gap-3 font-bold"><Icon name="music" /> Lofi Radio</span>
                                <span className="text-xs font-bold uppercase">{musicPlaying ? 'PLAYING' : 'OFF'}</span>
                            </button>
                            <button onClick={()=>setDarkMode(!darkMode)} className="w-full p-4 rounded-xl bg-slate-100 dark:bg-slate-800 dark:text-white flex items-center justify-between">
                                <span className="flex items-center gap-3 font-bold"><Icon name={darkMode?'moon':'sun'} /> Dark Mode</span>
                                <div className={`w-10 h-5 rounded-full relative transition-colors ${darkMode?'bg-brand':'bg-slate-300'}`}>
                                    <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${darkMode?'left-6':'left-1'}`}></div>
                                </div>
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // --- CUSTOMER DASHBOARD ---
        const CustomerDash = () => {
            const { user, salons, addToken, myTokens, setMyTokens, favorites, setFavorites, musicPlaying, setMusicPlaying, speak } = useContext(AppContext);
            const [view, setView] = useState('home');
            const [selectedSalon, setSelectedSalon] = useState(null);
            const [cart, setCart] = useState([]);
            const [showStylist, setShowStylist] = useState(false);
            const [showChat, setShowChat] = useState(false);
            const [showMagic, setShowMagic] = useState(false);

            // Salon Detail View
            if(view === 'salon' && selectedSalon) {
                return (
                    <div className="min-h-screen bg-slate-50 dark:bg-dark-950 pb-24 animate-fade-in">
                        <BackButton onClick={()=>setView('home')} />
                        <div className="h-72 relative">
                            <img src={selectedSalon.image} className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-gradient-to-t from-dark-950 via-dark-950/50 to-transparent"></div>
                            <div className="absolute bottom-6 left-6 text-white">
                                <h1 className="text-4xl font-display font-bold mb-2">{selectedSalon.name}</h1>
                                <p className="opacity-90 flex items-center gap-2"><Icon name="map-pin" size={16}/> {selectedSalon.location} • <Icon name="star" className="fill-yellow-400 text-yellow-400" size={16}/> {selectedSalon.rating}</p>
                            </div>
                        </div>
                        
                        <div className="p-6 -mt-6 relative z-10 bg-slate-50 dark:bg-dark-950 rounded-t-3xl">
                            <div className="flex gap-4 mb-8">
                                <div className="flex-1 bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center">
                                    <p className="text-xs font-bold text-slate-400 uppercase">Current Queue</p>
                                    <p className="text-2xl font-bold dark:text-white">{selectedSalon.queueLength}</p>
                                </div>
                                <div className="flex-1 bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center">
                                    <p className="text-xs font-bold text-slate-400 uppercase">Wait Time</p>
                                    <p className="text-2xl font-bold text-brand">~{selectedSalon.queueLength * 15}m</p>
                                </div>
                            </div>

                            <h3 className="font-bold text-xl dark:text-white mb-4">Select Services</h3>
                            <div className="space-y-3">
                                {selectedSalon.services.map(s => {
                                    const inCart = cart.find(x=>x.id===s.id);
                                    return (
                                        <div key={s.id} onClick={()=>{inCart?setCart(cart.filter(x=>x.id!==s.id)):setCart([...cart,s])}} 
                                            className={`p-4 rounded-xl border flex justify-between items-center cursor-pointer transition-all ${inCart?'border-brand bg-brand/10':'border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900'}`}>
                                            <div>
                                                <div className="font-bold dark:text-white text-lg">{s.name}</div>
                                                <div className="text-sm text-slate-500">₹{s.price} • {s.duration} mins</div>
                                            </div>
                                            <div className={`w-6 h-6 rounded-full border flex items-center justify-center transition-colors ${inCart?'bg-brand border-brand text-white':'border-slate-400'}`}>
                                                {inCart && <Icon name="check" size={14}/>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="fixed bottom-0 w-full p-4 bg-white/80 dark:bg-black/80 backdrop-blur border-t border-slate-200 dark:border-slate-800 z-20">
                            <button 
                                onClick={()=>{ addToken(selectedSalon, cart); setCart([]); setView('tokens'); }} 
                                disabled={cart.length===0}
                                className="w-full py-4 bg-brand text-white font-bold rounded-xl shadow-lg shadow-brand/30 disabled:opacity-50 transition-all active:scale-95"
                            >
                                {cart.length>0 ? `Book (${cart.length}) • ₹${cart.reduce((a,b)=>a+b.price,0)}` : 'Select Services to Book'}
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-dark-950 pb-24 transition-colors duration-300">
                    {/* Header */}
                    <div className="sticky top-0 z-30 bg-white/80 dark:bg-dark-950/80 backdrop-blur border-b border-slate-100 dark:border-slate-800 px-5 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <img src={user.photo || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.name}`} className="w-10 h-10 rounded-full border border-slate-200" />
                            <div><p className="text-xs font-bold text-slate-400">WELCOME BACK</p><h3 className="font-bold leading-none dark:text-white text-lg">{user.name.split(' ')[0]}</h3></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setShowMagic(true)} className="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white shadow-lg animate-pulse-slow">
                                <Icon name="wand-2" size={18}/>
                            </button>
                        </div>
                    </div>

                    <div className="p-5 space-y-8">
                        {view === 'home' && (
                            <>
                                {/* AI Stylist Promo */}
                                <div onClick={()=>setShowStylist(true)} className="relative h-48 rounded-3xl overflow-hidden cursor-pointer group shadow-2xl">
                                    <img src="https://images.unsplash.com/photo-1595152772835-219674b2a8a6?w=800&q=80" className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"/>
                                    <div className="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent flex flex-col justify-center p-8">
                                        <div className="bg-brand text-white text-[10px] font-bold px-2 py-1 rounded w-fit mb-2">NEW AI FEATURE</div>
                                        <h2 className="text-3xl font-bold text-white mb-1 font-display">Smart Stylist</h2>
                                        <p className="text-white/80 text-sm mb-4">Scan your face & get AI style suggestions.</p>
                                        <div className="flex items-center gap-2 text-white font-bold text-xs"><div className="p-1 bg-white/20 rounded-full"><Icon name="camera" size={12}/></div> Tap to Open Camera</div>
                                    </div>
                                </div>

                                {/* Salon List */}
                                <div>
                                    <h3 className="font-bold text-xl dark:text-white mb-4">Top Salons Nearby</h3>
                                    <div className="space-y-4">
                                        {salons.map(s => (
                                            <div key={s.id} onClick={()=>{setSelectedSalon(s); setView('salon')}} className="bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex gap-4 cursor-pointer hover:border-brand transition-colors group">
                                                <div className="w-24 h-24 rounded-xl overflow-hidden shrink-0 relative">
                                                    <img src={s.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform"/>
                                                </div>
                                                <div className="flex-1 py-1">
                                                    <div className="flex justify-between items-start">
                                                        <h4 className="font-bold text-slate-900 dark:text-white text-lg leading-tight">{s.name}</h4>
                                                        <span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded dark:text-white">⭐ {s.rating}</span>
                                                    </div>
                                                    <p className="text-sm text-slate-500 mt-1 mb-3">{s.location} • {s.gender}</p>
                                                    <div className="flex gap-2">
                                                        <span className="text-xs font-bold text-brand bg-brand/10 px-2 py-1 rounded">Wait: {s.queueLength*15}m</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}

                        {view === 'tokens' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold font-display dark:text-white">My Bookings</h2>
                                {myTokens.length === 0 ? (
                                    <div className="text-center py-20 opacity-50 dark:text-white"><Icon name="ticket" size={48} className="mx-auto mb-2"/><p>No active tokens</p></div>
                                ) : (
                                    myTokens.map(t => (
                                        <div key={t.id} className="bg-white dark:bg-slate-900 rounded-3xl overflow-hidden shadow-xl border border-slate-100 dark:border-slate-800 relative group">
                                            <div className="bg-brand p-6 text-white relative overflow-hidden">
                                                <div className="absolute top-0 right-0 p-4 opacity-20"><Icon name="scissors" size={80}/></div>
                                                <h3 className="font-bold text-xl">{t.salonName}</h3>
                                                <p className="text-sm opacity-80">{t.salonLocation}</p>
                                            </div>
                                            <div className="p-6 relative">
                                                <div className="ticket-notch notch-l shadow-inner dark:bg-dark-950"></div>
                                                <div className="ticket-notch notch-r shadow-inner dark:bg-dark-950"></div>
                                                <div className="border-b-2 border-dashed border-slate-200 dark:border-slate-700 pb-6 mb-6 flex justify-between items-center">
                                                    <div><p className="text-xs text-slate-400 font-bold uppercase">Token No.</p><p className="text-5xl font-display font-bold text-brand">#{t.tokenNumber}</p></div>
                                                    <div className="text-right"><p className="text-xs text-slate-400 font-bold uppercase">Est. Time</p><p className="text-2xl font-bold dark:text-white">{t.estimatedTime}</p></div>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <div><p className="font-bold dark:text-white text-sm">{t.serviceNames}</p></div>
                                                    <button onClick={()=>setMyTokens(myTokens.filter(x=>x.id!==t.id))} className="text-xs text-red-500 font-bold border border-red-100 px-3 py-1.5 rounded-lg hover:bg-red-50">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </div>

                    {/* Floating Chat Button */}
                    <button onClick={()=>setShowChat(!showChat)} className="fixed bottom-24 right-5 w-14 h-14 bg-brand rounded-full shadow-lg shadow-brand/40 text-white flex items-center justify-center z-30 hover:scale-110 transition-transform">
                        <Icon name="message-circle" size={28}/>
                    </button>

                    {showStylist && <SmartStylist onClose={()=>setShowStylist(false)} />}
                    {showChat && <ChatBot onClose={()=>setShowChat(false)} />}
                    {showMagic && <MagicMenu onClose={()=>setShowMagic(false)} />}

                    {/* Bottom Nav */}
                    <div className="fixed bottom-0 w-full bg-white/90 dark:bg-dark-950/90 backdrop-blur border-t border-slate-200 dark:border-slate-800 h-20 flex justify-around items-center z-30 pb-4">
                        {['home', 'tokens', 'profile'].map(t => (
                            <button key={t} onClick={()=>setView(t)} className={`flex flex-col items-center gap-1 transition-all ${view===t ? 'text-brand scale-110' : 'text-slate-400'}`}>
                                <Icon name={t==='home'?'home':t==='tokens'?'ticket':'user'} size={24} className={view===t?'fill-current':''} />
                                <span className="text-[10px] font-bold capitalize">{t}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- LOGIN & ROOT ---
        const Login = () => {
            const { googleLogin, setUser } = useContext(AppContext);
            const [role, setRole] = useState(null);
            
            const handleLogin = async () => {
                const u = await googleLogin();
                if(u) {
                    if(!role) { alert("Please select a role first!"); return; }
                    setUser({...u, role});
                }
            };

            return (
                <div className="min-h-screen bg-dark-950 flex items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=1600&q=80')] bg-cover bg-center opacity-30"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-dark-950 via-dark-950/80 to-transparent"></div>
                    
                    <motion.div initial={{opacity:0, scale:0.95}} animate={{opacity:1, scale:1}} className="relative z-10 w-full max-w-sm bg-black/40 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl text-white text-center">
                        <div className="w-20 h-20 bg-brand rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-brand/40">
                            <Icon name="scissors" size={40} className="text-white"/>
                        </div>
                        <h1 className="text-5xl font-display font-bold mb-2">Line Free</h1>
                        <p className="text-slate-300 mb-8">The AI-Powered Salon Experience</p>

                        {!role ? (
                            <div className="space-y-4">
                                <button onClick={()=>setRole('customer')} className="w-full p-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded-2xl flex items-center gap-4 transition-all">
                                    <div className="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><Icon name="user"/></div>
                                    <div className="text-left"><div className="font-bold text-lg">Customer</div><div className="text-xs text-slate-400">Book, Chat & Style</div></div>
                                </button>
                                <button onClick={()=>setRole('barber')} className="w-full p-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded-2xl flex items-center gap-4 transition-all">
                                    <div className="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400"><Icon name="scissors"/></div>
                                    <div className="text-left"><div className="font-bold text-lg">Salon Owner</div><div className="text-xs text-slate-400">Manage Business</div></div>
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-fade-in">
                                <div className="inline-flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full text-sm">
                                    <span>Joining as <b>{role.toUpperCase()}</b></span>
                                    <button onClick={()=>setRole(null)}><Icon name="x" size={14}/></button>
                                </div>
                                <button onClick={handleLogin} className="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-3 hover:scale-105 transition-transform">
                                    <Icon name="log-in"/> Continue with Google
                                </button>
                            </div>
                        )}
                    </motion.div>
                </div>
            );
        };

        const App = () => {
            const { user } = useContext(AppContext);
            // Simple Barber Dashboard Placeholder for completeness (Customer Dash is the focus)
            if (user && user.role === 'barber') return (
                <div className="min-h-screen bg-slate-900 text-white p-10 text-center">
                    <h1 className="text-4xl font-bold mb-4">Owner Dashboard</h1>
                    <p>Refer to previous version for Owner features.</p>
                    <button onClick={()=>window.location.reload()} className="mt-4 bg-red-500 px-4 py-2 rounded">Logout</button>
                </div>
            );
            return user ? <CustomerDash /> : <Login />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<AppProvider><App /></AppProvider>);
    </script>
</body>
</html>


