<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Free India - Business OS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#050505',
                        surface: '#121212',
                        surfaceLight: '#1E1E1E',
                        surfaceLighter: '#2A2A2A',
                        primary: '#FFD700', // Gold
                        primaryDim: '#C5A000',
                        accent: '#3B82F6',
                        danger: '#EF4444',
                        success: '#22C55E',
                        warning: '#F59E0B',
                        textMain: '#FFFFFF',
                        textSec: '#9CA3AF',
                        border: 'rgba(255, 255, 255, 0.1)'
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pop': 'pop 0.2s ease-out forwards',
                    },
                    keyframes: {
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 5px rgba(255, 215, 0, 0.2)' }, '50%': { boxShadow: '0 0 20px rgba(255, 215, 0, 0.5)' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #050505; color: #ffffff; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .stripe-bg { background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, where, orderBy, updateDoc, serverTimestamp, deleteDoc, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYJq8T7hMP3OsZ0PYqkWe-dDCWB8_b0Ck",
            authDomain: "line-free-4bb96.firebaseapp.com",
            projectId: "line-free-4bb96",
            storageBucket: "line-free-4bb96.firebasestorage.app",
            messagingSenderId: "137966607796",
            appId: "1:137966607796:web:bc84b4884650911d9ea6e1",
            measurementId: "G-6Z6YQ8Z6CC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // --- LOCALIZATION ---
        const TEXTS = {
            en: {
                selectLang: "Select Language",
                continue: "Continue",
                loginCust: "Login as Customer",
                loginOwn: "Login as Salon Owner",
                custDesc: "Book haircuts & avoid lines",
                ownDesc: "Manage business & queue",
                welcome: "Welcome",
                skipLine: "Skip the Line.",
                ownTime: "Own the Time.",
                smartQueue: "Smart Queue System",
                resetLang: "Change Language"
            },
            hi: {
                selectLang: "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç",
                continue: "‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç",
                loginCust: "‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç",
                loginOwn: "‡§∏‡•à‡§≤‡•Ç‡§® ‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç",
                custDesc: "‡§π‡•á‡§Ø‡§∞‡§ï‡§ü ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ï‡§§‡§æ‡§∞ ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç",
                ownDesc: "‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§î‡§∞ ‡§ï‡§§‡§æ‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
                welcome: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à",
                skipLine: "‡§≤‡§æ‡§á‡§® ‡§õ‡•ã‡§°‡§º‡•á‡§Ç‡•§",
                ownTime: "‡§∏‡§Æ‡§Ø ‡§¨‡§ö‡§æ‡§è‡§Ç‡•§",
                smartQueue: "‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§ï‡§§‡§æ‡§∞ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä",
                resetLang: "‡§≠‡§æ‡§∑‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç"
            }
        };

        // --- UTILS ---
        const Icon = ({ name, size = 20, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        const getDistance = (lat1, lon1, lat2, lon2) => {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        };

        const calculateQueueStats = (queue, myTokenNumber, breakDuration = 0) => {
            const ahead = queue.filter(t => 
                (t.status === 'waiting' || t.status === 'serving') && 
                t.tokenNumber < myTokenNumber
            );
            let totalMins = ahead.reduce((acc, curr) => acc + (curr.totalDuration || 30), 0);
            if(breakDuration > 0) totalMins += breakDuration;
            return { peopleAhead: ahead.length, waitTime: totalMins };
        };

        // --- COMPONENTS ---

        // 1. SPLASH SCREEN
        const SplashScreen = ({ onFinish }) => {
            useEffect(() => {
                lucide.createIcons();
                const timer = setTimeout(onFinish, 2500);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className="fixed inset-0 z-50 bg-bg flex flex-col items-center justify-center">
                    <div className="w-28 h-28 rounded-3xl glass border border-primary/30 flex items-center justify-center mb-8 animate-pulse-glow shadow-[0_0_40px_rgba(255,215,0,0.1)]">
                        <Icon name="scissors" size={60} className="text-primary" />
                    </div>
                    <h1 className="text-5xl font-black text-white tracking-tighter">
                        LINE FREE <span className="text-primary">INDIA</span>
                    </h1>
                </div>
            );
        };

        // 2. LANGUAGE SELECTION
        const LanguageSelection = ({ onSelect }) => {
            useEffect(() => lucide.createIcons(), []);
            return (
                <div className="min-h-screen bg-bg p-6 flex flex-col justify-center animate-slide-up">
                    <h2 className="text-3xl font-bold text-white mb-8 text-center">Select Language / ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</h2>
                    <div className="space-y-4">
                        <button onClick={() => onSelect('en')} className="w-full bg-surfaceLight p-6 rounded-2xl border border-white/5 flex items-center justify-between hover:border-primary/50 transition-all group">
                            <div className="flex items-center gap-4">
                                <span className="text-2xl">üá∫üá∏</span>
                                <span className="text-lg font-bold text-white">English</span>
                            </div>
                            <div className="w-6 h-6 rounded-full border border-white/20 group-hover:bg-primary group-hover:border-primary"></div>
                        </button>
                        <button onClick={() => onSelect('hi')} className="w-full bg-surfaceLight p-6 rounded-2xl border border-white/5 flex items-center justify-between hover:border-primary/50 transition-all group">
                            <div className="flex items-center gap-4">
                                <span className="text-2xl">üáÆüá≥</span>
                                <span className="text-lg font-bold text-white">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</span>
                            </div>
                            <div className="w-6 h-6 rounded-full border border-white/20 group-hover:bg-primary group-hover:border-primary"></div>
                        </button>
                    </div>
                </div>
            );
        };

        // 3. ROLE-BASED LOGIN SCREEN
        const RoleBasedLogin = ({ onLogin, t }) => {
            useEffect(() => lucide.createIcons(), []);
            return (
                <div className="min-h-screen bg-bg p-6 flex flex-col justify-end pb-16 relative overflow-hidden animate-slide-up">
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1621644827823-3932a39287a9?w=800&q=80')] bg-cover opacity-20 grayscale"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-bg via-bg/90 to-transparent"></div>
                    
                    <div className="relative z-10 mb-8">
                        <h1 className="text-5xl font-bold text-white mb-2 leading-tight">{t.skipLine}<br/><span className="text-primary">{t.ownTime}</span></h1>
                        <p className="text-textSec text-lg">{t.smartQueue}</p>
                    </div>

                    <div className="relative z-10 space-y-4">
                        <button onClick={() => onLogin('customer')} className="w-full bg-white text-black p-4 rounded-xl flex items-center gap-4 hover:scale-[1.02] transition-transform shadow-xl group">
                            <div className="w-12 h-12 bg-black/5 rounded-full flex items-center justify-center text-black"><Icon name="user" size={24} /></div>
                            <div className="text-left">
                                <h3 className="text-lg font-bold">{t.loginCust}</h3>
                                <p className="text-xs text-gray-600">{t.custDesc}</p>
                            </div>
                        </button>

                        <button onClick={() => onLogin('owner')} className="w-full bg-surfaceLight border border-white/10 text-white p-4 rounded-xl flex items-center gap-4 hover:border-primary/50 transition-all group">
                            <div className="w-12 h-12 bg-surface rounded-full flex items-center justify-center text-white border border-white/10 group-hover:text-primary"><Icon name="store" size={24} /></div>
                            <div className="text-left">
                                <h3 className="text-lg font-bold">{t.loginOwn}</h3>
                                <p className="text-xs text-textSec">{t.ownDesc}</p>
                            </div>
                        </button>
                    </div>
                </div>
            );
        };

        const BottomNav = ({ activeTab, onTabChange, role }) => (
            <div className="fixed bottom-0 w-full glass pb-6 pt-3 px-4 flex justify-around items-center z-50 transition-all border-t border-white/5">
                {role === 'customer' ? (
                    <>
                        <button onClick={() => onTabChange('home')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'home' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="store" size={24} />
                            <span className="text-[10px] font-bold">Salons</span>
                        </button>
                        <button onClick={() => onTabChange('favorites')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'favorites' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="heart" size={24} />
                            <span className="text-[10px] font-bold">Favs</span>
                        </button>
                        <button onClick={() => onTabChange('activity')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'activity' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="ticket" size={24} />
                            <span className="text-[10px] font-bold">Token</span>
                        </button>
                        <button onClick={() => onTabChange('subscription')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'subscription' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="crown" size={24} />
                            <span className="text-[10px] font-bold">Pro</span>
                        </button>
                    </>
                ) : (
                    <>
                        <button onClick={() => onTabChange('home')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'home' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="sliders" size={24} />
                            <span className="text-[10px] font-bold">Control</span>
                        </button>
                        <button onClick={() => onTabChange('services')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'services' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="list" size={24} />
                            <span className="text-[10px] font-bold">Menu</span>
                        </button>
                        <button onClick={() => onTabChange('qr')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'qr' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                            <Icon name="qr-code" size={24} />
                            <span className="text-[10px] font-bold">QR</span>
                        </button>
                    </>
                )}
                <button onClick={() => onTabChange('profile')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${activeTab === 'profile' ? 'text-primary bg-primary/10' : 'text-textSec'}`}>
                    <Icon name="user" size={24} />
                    <span className="text-[10px] font-bold">Profile</span>
                </button>
            </div>
        );

        const ProfileScreen = ({ user, role, onLogout, onSwitchRole, onChangeLang, t }) => (
            <div className="p-6 pb-24 animate-slide-up min-h-screen">
                <h2 className="text-2xl font-bold text-white mb-8">My Account</h2>
                <div className="flex items-center gap-4 mb-8 bg-surfaceLight p-5 rounded-2xl border border-white/5 shadow-lg">
                    <img src={user.photoURL} className="w-16 h-16 rounded-full border-2 border-primary shadow-lg shadow-primary/20" />
                    <div>
                        <h3 className="text-lg font-bold text-white">{user.displayName}</h3>
                        <p className="text-textSec text-sm mb-2">{user.email}</p>
                        <span className="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-primary text-black">{role}</span>
                    </div>
                </div>

                <div className="space-y-4">
                    <button onClick={onSwitchRole} className="w-full bg-white/5 p-4 rounded-xl border border-white/5 flex justify-between items-center hover:bg-white/10 transition-all group">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-primary rounded-lg text-black"><Icon name="refresh-cw" size={20}/></div>
                            <div className="text-left">
                                <span className="font-bold text-white block">Switch Profile</span>
                                <span className="text-xs text-textSec">Change between Owner/Customer</span>
                            </div>
                        </div>
                        <Icon name="chevron-right" size={16} className="text-textSec group-hover:text-white"/>
                    </button>

                    <button onClick={onChangeLang} className="w-full bg-surfaceLight p-4 rounded-xl border border-white/5 flex justify-between items-center hover:bg-white/5">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-black/30 rounded-lg text-white"><Icon name="globe" size={20}/></div>
                            <span className="font-bold text-white">{t.resetLang}</span>
                        </div>
                        <Icon name="chevron-right" size={16} className="text-textSec"/>
                    </button>

                    <button onClick={onLogout} className="w-full mt-8 py-4 rounded-xl bg-danger/10 text-danger font-bold flex items-center justify-center gap-2 hover:bg-danger/20 transition-all border border-danger/20">
                        <Icon name="log-out" size={20} /> Logout
                    </button>
                </div>
            </div>
        );

        const SubscriptionScreen = () => (
            <div className="p-6 pb-24 animate-slide-up min-h-screen flex flex-col items-center justify-center text-center">
                <div className="w-24 h-24 bg-gradient-to-br from-primary to-orange-500 rounded-full flex items-center justify-center mb-6 animate-pulse-glow shadow-2xl">
                    <Icon name="crown" size={48} className="text-black" />
                </div>
                <h2 className="text-3xl font-black text-white mb-2">LINE FREE <span className="text-primary">PRO</span></h2>
                <p className="text-textSec text-sm mb-8 max-w-xs">Upgrade for priority queuing, zero ads, and advanced booking slots.</p>
                <div className="bg-surfaceLight p-6 rounded-3xl border border-white/10 w-full max-w-sm text-left relative overflow-hidden">
                    <div className="absolute top-0 right-0 bg-primary text-black text-[10px] font-bold px-3 py-1 rounded-bl-xl">FREE TRIAL</div>
                    <div className="space-y-4">
                        <div className="flex items-center gap-3"><Icon name="check-circle" size={18} className="text-success" /><span className="text-sm">Priority Booking</span></div>
                        <div className="flex items-center gap-3"><Icon name="check-circle" size={18} className="text-success" /><span className="text-sm">No Ads</span></div>
                    </div>
                </div>
            </div>
        );

        const OwnerDashboard = ({ user, onLogout, onSwitchRole, onChangeLang, t }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [salon, setSalon] = useState(null);
            const [queue, setQueue] = useState([]);
            const [services, setServices] = useState([]);
            const [setupName, setSetupName] = useState('');
            const [setupAddr, setSetupAddr] = useState('');

            useEffect(() => {
                const unsubSalon = onSnapshot(doc(db, "salons", user.uid), (docSnap) => {
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        setSalon(data);
                        setServices(data.services || []);
                        if(docSnap.data().shopName) {
                            setSetupName(docSnap.data().shopName);
                            setSetupAddr(docSnap.data().address);
                        }
                        const today = new Date().toDateString();
                        if (data.lastResetDate !== today) {
                            updateDoc(doc(db, "salons", user.uid), {
                                totalTokensToday: 0, lastResetDate: today, revenue: 0
                            });
                        }
                    }
                });
                const q = query(
                    collection(db, "tokens"), 
                    where("salonId", "==", user.uid), 
                    where("status", "in", ["waiting", "serving"]),
                    orderBy("tokenNumber", "asc")
                );
                const unsubQueue = onSnapshot(q, (s) => setQueue(s.docs.map(d => ({id:d.id, ...d.data()}))));
                return () => { unsubSalon(); unsubQueue(); }
            }, [user]);

            useEffect(() => { lucide.createIcons(); });

            const handleSetup = async () => {
                await setDoc(doc(db, "salons", user.uid), {
                    shopName: setupName, address: setupAddr,
                    shopImage: 'https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=800&q=80',
                    ownerName: user.displayName, status: 'open', acceptingTokens: true, breakDuration: 0, revenue: 0, rating: 5.0, 
                    lastTokenNumber: 0, currentTokenNumber: 0, lastResetDate: new Date().toDateString(),
                    services: [{ name: 'Haircut', price: 200, time: 30 }, { name: 'Shave', price: 100, time: 15 }],
                    createdAt: serverTimestamp()
                });
            };

            const toggleStatus = (newStatus) => updateDoc(doc(db, "salons", user.uid), { status: newStatus, acceptingTokens: newStatus === 'open', breakDuration: newStatus === 'break' ? 15 : 0 });
            const toggleTokenStop = () => updateDoc(doc(db, "salons", user.uid), { acceptingTokens: !salon.acceptingTokens });

            const nextCustomer = async () => {
                const serving = queue.find(t => t.status === 'serving');
                const next = queue.find(t => t.status === 'waiting');
                await runTransaction(db, async (t) => {
                    const salonRef = doc(db, "salons", user.uid);
                    if(serving) {
                        t.update(doc(db, "tokens", serving.id), { status: 'completed' });
                        const sDoc = await t.get(salonRef);
                        t.update(salonRef, { revenue: (sDoc.data().revenue || 0) + (serving.totalCost || 0) });
                    }
                    if(next) {
                        t.update(doc(db, "tokens", next.id), { status: 'serving' });
                        t.update(salonRef, { currentTokenNumber: next.tokenNumber });
                    } else t.update(salonRef, { currentTokenNumber: 0 });
                });
            };

            if(!salon || !salon.shopName) {
                return (
                    <div className="min-h-screen bg-bg p-6 pt-20 animate-slide-up">
                        <h2 className="text-3xl font-bold text-white mb-2">Setup Salon</h2>
                        <div className="space-y-4">
                            <input value={setupName} onChange={e=>setSetupName(e.target.value)} placeholder="Shop Name" className="w-full bg-surfaceLight border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary" />
                            <input value={setupAddr} onChange={e=>setSetupAddr(e.target.value)} placeholder="Address" className="w-full bg-surfaceLight border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary" />
                            <button onClick={handleSetup} disabled={!setupName} className="w-full bg-primary text-black font-bold py-4 rounded-xl mt-4">Launch üöÄ</button>
                        </div>
                    </div>
                );
            }

            const currentToken = queue.find(t => t.status === 'serving');

            return (
                <div className="min-h-screen bg-bg">
                    {activeTab === 'home' && (
                        <div className="pb-24">
                            <div className="p-6 bg-surfaceLight rounded-b-3xl border-b border-white/5 relative overflow-hidden">
                                <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                                <div className="relative z-10 flex justify-between items-start">
                                    <div>
                                        <h1 className="text-2xl font-bold text-white">{salon.shopName}</h1>
                                        <div className="flex items-center gap-2 mt-1">
                                            <div className={`w-2 h-2 rounded-full ${salon.status==='open'?'bg-success animate-pulse':salon.status==='break'?'bg-warning':'bg-danger'}`}></div>
                                            <span className="text-xs font-bold uppercase text-textSec">{salon.status}</span>
                                        </div>
                                    </div>
                                    <div className="text-right"><p className="text-xs text-textSec uppercase">Revenue</p><p className="text-xl font-bold text-success">‚Çπ{salon.revenue}</p></div>
                                </div>
                            </div>
                            <div className="p-6 space-y-6">
                                <div className="bg-primary p-6 rounded-3xl text-black shadow-lg shadow-primary/20 relative overflow-hidden">
                                    <div className="absolute -right-4 -top-4 opacity-10"><Icon name="users" size={100}/></div>
                                    <p className="text-xs font-bold uppercase opacity-60 mb-2">Now Serving</p>
                                    <div className="flex justify-between items-end mb-6">
                                        <div>
                                            <h2 className="text-6xl font-black tracking-tighter">{currentToken ? currentToken.tokenNumber : '-'}</h2>
                                            <p className="font-bold mt-1">{currentToken ? currentToken.userName : 'Queue Empty'}</p>
                                        </div>
                                        <button onClick={nextCustomer} className="w-16 h-16 bg-black text-white rounded-full flex items-center justify-center hover:scale-105 transition-transform active:scale-95 shadow-xl"><Icon name="arrow-right" size={32}/></button>
                                    </div>
                                </div>
                                <div className="bg-surfaceLight p-4 rounded-2xl border border-white/5">
                                    <h3 className="text-sm font-bold text-white mb-4 flex justify-between"><span>Waiting Queue</span><span className="text-primary">{queue.filter(t=>t.status==='waiting').length}</span></h3>
                                    <div className="space-y-2 max-h-40 overflow-y-auto">
                                        {queue.filter(t=>t.status==='waiting').map(t => (
                                            <div key={t.id} className="flex justify-between items-center bg-surface p-3 rounded-xl border border-white/5">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-xs font-bold">{t.tokenNumber}</div>
                                                    <div><p className="text-sm font-bold text-white">{t.userName}</p><p className="text-[10px] text-textSec">{t.totalDuration} min</p></div>
                                                </div>
                                            </div>
                                        ))}
                                        {queue.filter(t=>t.status==='waiting').length === 0 && <p className="text-xs text-textSec text-center py-2">No one in line.</p>}
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={()=>toggleStatus('open')} className={`p-4 rounded-xl border flex flex-col items-center gap-1 ${salon.status==='open' ? 'bg-success/20 border-success text-success' : 'bg-surfaceLight border-white/5 text-textSec'}`}><Icon name="unlock" size={20}/><span className="text-xs font-bold">OPEN</span></button>
                                    <button onClick={()=>toggleStatus('closed')} className={`p-4 rounded-xl border flex flex-col items-center gap-1 ${salon.status==='closed' ? 'bg-danger/20 border-danger text-danger' : 'bg-surfaceLight border-white/5 text-textSec'}`}><Icon name="lock" size={20}/><span className="text-xs font-bold">CLOSE</span></button>
                                    <button onClick={()=>toggleStatus('break')} className={`p-4 rounded-xl border flex flex-col items-center gap-1 ${salon.status==='break' ? 'bg-warning/20 border-warning text-warning' : 'bg-surfaceLight border-white/5 text-textSec'}`}><Icon name="coffee" size={20}/><span className="text-xs font-bold">BREAK</span></button>
                                    <button onClick={toggleTokenStop} className={`p-4 rounded-xl border flex flex-col items-center gap-1 ${!salon.acceptingTokens ? 'bg-white/20 border-white text-white' : 'bg-surfaceLight border-white/5 text-textSec'}`}><Icon name="stop-circle" size={20}/><span className="text-xs font-bold">{salon.acceptingTokens ? 'STOP TOKEN' : 'RESUME'}</span></button>
                                </div>
                            </div>
                        </div>
                    )}
                    {activeTab === 'services' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Manage Services</h2>
                            {services.map((s, i) => (
                                <div key={i} className="flex justify-between items-center bg-surfaceLight p-4 rounded-xl border border-white/5 mb-3">
                                    <div><h4 className="font-bold text-white">{s.name}</h4><p className="text-xs text-textSec">{s.time} mins</p></div>
                                    <div className="flex items-center gap-4"><span className="font-bold text-primary">‚Çπ{s.price}</span><button onClick={async ()=>{ const updated = services.filter((_, idx) => idx !== i); await updateDoc(doc(db, "salons", user.uid), {services: updated}); }} className="text-danger"><Icon name="trash-2" size={18}/></button></div>
                                </div>
                            ))}
                            <button onClick={async ()=>{ const name = prompt("Service Name?"); const price = prompt("Price?"); const time = prompt("Time?"); if(name && price) { const updated = [...services, {name, price: parseInt(price), time: parseInt(time)||30}]; await updateDoc(doc(db, "salons", user.uid), {services: updated}); } }} className="w-full py-4 mt-4 border border-dashed border-white/20 rounded-xl text-textSec hover:border-primary hover:text-primary">Add New Service</button>
                        </div>
                    )}
                    {activeTab === 'qr' && (
                        <div className="p-6 pb-24 flex flex-col items-center justify-center h-screen animate-slide-up">
                            <div className="bg-white p-6 rounded-3xl mb-6 shadow-2xl"><div id="qrcode"></div></div>
                            <h2 className="text-2xl font-bold text-white">{salon.shopName}</h2>
                            <button onClick={()=> { document.getElementById("qrcode").innerHTML = ""; new QRCode(document.getElementById("qrcode"), { text: `https://linefree.app/salon/${user.uid}`, width: 200, height: 200 }); }} className="px-6 py-3 bg-primary text-black font-bold rounded-xl mt-4">Generate QR</button>
                        </div>
                    )}
                    {activeTab === 'profile' && <ProfileScreen user={user} role="Owner" onLogout={onLogout} onSwitchRole={onSwitchRole} onChangeLang={onChangeLang} t={t} />}
                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} role="owner" />
                </div>
            );
        };

        const CustomerDashboard = ({ user, onLogout, onSwitchRole, onChangeLang, t }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [salons, setSalons] = useState([]);
            const [favorites, setFavorites] = useState([]);
            const [activeToken, setActiveToken] = useState(null);
            const [selectedSalon, setSelectedSalon] = useState(null);
            const [selectedServices, setSelectedServices] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [userLocation, setUserLocation] = useState(null);
            const [queueStats, setQueueStats] = useState({ peopleAhead: 0, waitTime: 0 });

            useEffect(() => {
                const unsubS = onSnapshot(collection(db, "salons"), s => setSalons(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubU = onSnapshot(doc(db, "users", user.uid), s => { if(s.exists()) setFavorites(s.data().favorites || []); });
                const q = query(collection(db, "tokens"), where("userId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubT = onSnapshot(q, s => setActiveToken(!s.empty ? {id:s.docs[0].id, ...s.docs[0].data()} : null));
                if (navigator.geolocation) navigator.geolocation.getCurrentPosition(p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }));
                return () => { unsubS(); unsubT(); unsubU(); }
            }, [user]);

            useEffect(() => {
                if (!activeToken) return;
                const q = query(collection(db, "tokens"), where("salonId", "==", activeToken.salonId), where("status", "in", ["waiting", "serving"]));
                const unsub = onSnapshot(q, snap => {
                    const all = snap.docs.map(d => d.data());
                    getDoc(doc(db, "salons", activeToken.salonId)).then(s => setQueueStats(calculateQueueStats(all, activeToken.tokenNumber, s.data().status==='break'?s.data().breakDuration:0)));
                });
                return () => unsub();
            }, [activeToken]);

            useEffect(() => lucide.createIcons(), [activeTab, salons, selectedSalon, activeToken]);

            const toggleService = (s) => selectedServices.includes(s) ? setSelectedServices(selectedServices.filter(x=>x!==s)) : setSelectedServices([...selectedServices,s]);
            const joinQueue = async () => {
                if(!selectedServices.length) return;
                await runTransaction(db, async (t) => {
                    const sRef = doc(db, "salons", selectedSalon.id);
                    const sDoc = await t.get(sRef);
                    const nextToken = (sDoc.data().lastTokenNumber || 0) + 1;
                    t.update(sRef, { lastTokenNumber: nextToken });
                    const tRef = doc(collection(db, "tokens"));
                    t.set(tRef, {
                        userId: user.uid, userName: user.displayName, salonId: selectedSalon.id, salonName: selectedSalon.shopName,
                        services: selectedServices, totalDuration: selectedServices.reduce((a,b)=>a+b.time,0), totalCost: selectedServices.reduce((a,b)=>a+b.price,0),
                        tokenNumber: nextToken, status: 'waiting', createdAt: serverTimestamp()
                    });
                });
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                setSelectedSalon(null); setSelectedServices([]); setActiveTab('activity');
            };

            const sortedSalons = useMemo(() => {
                let list = salons.filter(s => s.shopName.toLowerCase().includes(searchQuery.toLowerCase()));
                if(userLocation) list.sort((a,b) => {
                    const dA = a.coordinates ? getDistance(userLocation.lat,userLocation.lng,a.coordinates.lat,a.coordinates.lng) : 9999;
                    const dB = b.coordinates ? getDistance(userLocation.lat,userLocation.lng,b.coordinates.lat,b.coordinates.lng) : 9999;
                    return dA - dB;
                });
                return list;
            }, [salons, searchQuery, userLocation]);

            return (
                <div className="min-h-screen bg-bg">
                    {selectedSalon && (
                        <div className="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-end sm:items-center justify-center p-4 animate-slide-up">
                            <div className="w-full max-w-md bg-surfaceLight border border-white/10 rounded-3xl p-6 relative">
                                <button onClick={()=>setSelectedSalon(null)} className="absolute top-4 right-4 text-textSec"><Icon name="x"/></button>
                                <h2 className="text-xl font-bold text-white mb-1">{selectedSalon.shopName}</h2>
                                <div className="space-y-2 mb-6 max-h-60 overflow-y-auto mt-4">
                                    {selectedSalon.services?.map((s,i) => (
                                        <div key={i} onClick={()=>toggleService(s)} className={`flex justify-between items-center p-4 rounded-xl border cursor-pointer ${selectedServices.includes(s) ? 'border-primary bg-primary/10' : 'border-white/5 bg-surface'}`}>
                                            <div><div className="font-bold">{s.name}</div><div className="text-xs text-textSec">{s.time} min ‚Ä¢ ‚Çπ{s.price}</div></div>
                                            {selectedServices.includes(s) && <Icon name="check-circle" size={18} className="text-primary"/>}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex justify-between items-center border-t border-white/10 pt-4 mb-4">
                                    <div><p className="text-xs text-textSec">Total</p><p className="font-bold text-white">‚Çπ{selectedServices.reduce((a,b)=>a+b.price,0)}</p></div>
                                    <div><p className="text-xs text-textSec text-right">Time</p><p className="font-bold text-white">{selectedServices.reduce((a,b)=>a+b.time,0)} min</p></div>
                                </div>
                                <button onClick={joinQueue} className="w-full bg-primary text-black font-bold py-4 rounded-xl">Confirm Token</button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'home' && (
                        <div className="p-6 pb-24">
                            <div className="flex justify-between items-center mb-6 sticky top-0 bg-bg z-20 py-4 border-b border-white/5">
                                <h1 className="text-xl font-bold text-white">Line Free <span className="text-primary">India</span></h1>
                                <img src={user.photoURL} className="w-8 h-8 rounded-full border border-primary/50" />
                            </div>
                            <div className="relative mb-6">
                                <Icon name="search" className="absolute left-4 top-3.5 text-textSec" size={18} />
                                <input value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} placeholder="Search salons..." className="w-full bg-surfaceLight border border-white/5 rounded-2xl py-3 pl-12 pr-4 text-white focus:border-primary outline-none" />
                            </div>
                            <div className="space-y-4">
                                {sortedSalons.map(s => {
                                    const dist = userLocation && s.coordinates ? getDistance(userLocation.lat, userLocation.lng, s.coordinates.lat, s.coordinates.lng) : null;
                                    return (
                                        <div key={s.id} onClick={()=>setSelectedSalon(s)} className="bg-surfaceLight p-4 rounded-2xl border border-white/5 flex gap-4 relative active:scale-[0.98] transition-transform">
                                            <button onClick={async (e)=>{e.stopPropagation(); const ref=doc(db,"users",user.uid); if(favorites.includes(s.id)) await updateDoc(ref,{favorites:arrayRemove(s.id)}); else await updateDoc(ref,{favorites:arrayUnion(s.id)});}} className="absolute top-3 right-3 z-10"><Icon name="heart" size={18} className={favorites.includes(s.id)?'fill-danger text-danger':'text-white'}/></button>
                                            <img src={s.shopImage} className="w-20 h-20 rounded-xl object-cover bg-surface" />
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start"><h3 className="font-bold text-white pr-6">{s.shopName}</h3><span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded ${s.status==='open'?'bg-success/10 text-success': s.status==='break' ? 'bg-warning/10 text-warning' : 'bg-danger/10 text-danger'}`}>{s.status}</span></div>
                                                <p className="text-xs text-textSec mt-1 flex items-center gap-1"><Icon name="map-pin" size={10}/> {s.address} {dist && <span className="text-primary">({dist} km)</span>}</p>
                                                <button disabled={s.status!=='open' || !s.acceptingTokens || activeToken} className="mt-3 bg-white text-black text-xs font-bold py-2 w-full rounded-lg hover:bg-primary transition-colors disabled:opacity-50">{activeToken ? 'Active Token' : s.status === 'open' && s.acceptingTokens ? 'Get Token' : 'Unavailable'}</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {activeTab === 'favorites' && <div className="p-6 pb-24"><h2 className="text-2xl font-bold mb-4">Favorites</h2><div className="space-y-4">{salons.filter(s=>favorites.includes(s.id)).map(s=>(<div key={s.id} onClick={()=>setSelectedSalon(s)} className="bg-surfaceLight p-4 rounded-2xl border border-white/5 flex gap-4"><img src={s.shopImage} className="w-16 h-16 rounded-xl object-cover"/><div className="flex-1"><h3 className="font-bold">{s.shopName}</h3><p className="text-xs text-textSec">{s.address}</p></div></div>))}</div></div>}

                    {activeTab === 'activity' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Live Token</h2>
                            {activeToken ? (
                                <div className="bg-surfaceLight border border-primary/40 p-6 rounded-[2rem] relative overflow-hidden animate-slide-up shadow-[0_0_20px_rgba(255,215,0,0.15)]">
                                    <div className="text-center mt-4">
                                        <div className="inline-block px-3 py-1 bg-primary/20 text-primary text-[10px] font-bold uppercase rounded-full mb-2 animate-pulse">Live Status</div>
                                        <h1 className="text-7xl font-black text-white tracking-tighter">{activeToken.tokenNumber}</h1>
                                        <p className="text-gray-400 mt-1 text-sm font-medium">{activeToken.salonName}</p>
                                        <div className="grid grid-cols-2 gap-4 mt-8 pt-6 border-t border-white/10">
                                            <div><p className="text-3xl font-bold text-white">{queueStats.peopleAhead}</p><p className="text-[10px] text-textSec uppercase tracking-wider">People Ahead</p></div>
                                            <div><p className="text-3xl font-bold text-primary">{queueStats.waitTime}<span className="text-sm">m</span></p><p className="text-[10px] text-textSec uppercase tracking-wider">Est. Wait</p></div>
                                        </div>
                                        <button onClick={()=>updateDoc(doc(db, "tokens", activeToken.id), {status: 'cancelled'})} className="mt-8 w-full py-3 rounded-xl border border-danger/20 text-danger text-xs font-bold hover:bg-danger/10 transition-colors">Cancel Booking</button>
                                    </div>
                                </div>
                            ) : <div className="text-center py-20 opacity-50"><Icon name="ticket" size={48} className="mx-auto mb-4"/><p>No active bookings.</p><button onClick={()=>setActiveTab('home')} className="mt-4 text-primary font-bold text-sm">Book Now</button></div>}
                        </div>
                    )}

                    {activeTab === 'subscription' && <SubscriptionScreen />}
                    {activeTab === 'profile' && <ProfileScreen user={user} role="Customer" onLogout={onLogout} onSwitchRole={onSwitchRole} onChangeLang={onChangeLang} t={t} />}
                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} role="customer" />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [lang, setLang] = useState(localStorage.getItem('lf_lang'));
            const [splash, setSplash] = useState(true);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if(u) {
                        const snap = await getDoc(doc(db, "users", u.uid));
                        if(snap.exists()) setRole(snap.data().role);
                    }
                });
                return () => unsub();
            }, []);

            const handleLogin = (selectedRole) => {
                signInWithPopup(auth, googleProvider).then(async (res) => {
                    const userRef = doc(db, "users", res.user.uid);
                    const snap = await getDoc(userRef);
                    if (!snap.exists()) {
                        await setDoc(userRef, { role: selectedRole, email: res.user.email, displayName: res.user.displayName, photoURL: res.user.photoURL, createdAt: serverTimestamp() });
                        setRole(selectedRole);
                    } else {
                        setRole(snap.data().role);
                    }
                });
            };

            const switchRole = async () => { if(confirm("Switch Profile?")) { await deleteDoc(doc(db, "users", user.uid)); setRole(null); } };
            const changeLang = () => { const l = lang === 'en' ? 'hi' : 'en'; setLang(l); localStorage.setItem('lf_lang', l); };

            if (splash) return <SplashScreen onFinish={() => setSplash(false)} />;
            if (!lang) return <LanguageSelection onSelect={(l) => { setLang(l); localStorage.setItem('lf_lang', l); }} />;
            
            const t = TEXTS[lang];

            return !user ? <RoleBasedLogin onLogin={handleLogin} t={t} /> : 
                   !role ? <RoleBasedLogin onLogin={handleLogin} t={t} /> : 
                   role === 'owner' ? <OwnerDashboard user={user} onLogout={() => signOut(auth)} onSwitchRole={switchRole} onChangeLang={changeLang} t={t} /> : <CustomerDashboard user={user} onLogout={() => signOut(auth)} onSwitchRole={switchRole} onChangeLang={changeLang} t={t} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
