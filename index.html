<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Free India - Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        surface: '#121212',
                        surfaceHighlight: '#1E1E1E',
                        gold: '#FFD700',
                        goldDim: '#B8860B',
                        danger: '#FF453A',
                        success: '#30D158',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-gold': 'pulseGold 2s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        pulseGold: { '0%, 100%': { boxShadow: '0 0 0px rgba(255, 215, 0, 0)' }, '50%': { boxShadow: '0 0 20px rgba(255, 215, 0, 0.3)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #000000; color: #ffffff; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, query, where, orderBy, updateDoc, serverTimestamp, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYJq8T7hMP3OsZ0PYqkWe-dDCWB8_b0Ck",
            authDomain: "line-free-4bb96.firebaseapp.com",
            projectId: "line-free-4bb96",
            storageBucket: "line-free-4bb96.firebasestorage.app",
            messagingSenderId: "137966607796",
            appId: "1:137966607796:web:bc84b4884650911d9ea6e1",
            measurementId: "G-6Z6YQ8Z6CC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const { useState, useEffect, useRef } = React;
        const Icon = ({ name, size = 20, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        // --- SPLASH SCREEN ---
        const SplashScreen = ({ onFinish }) => {
            useEffect(() => {
                lucide.createIcons();
                setTimeout(onFinish, 2000);
            }, []);
            return (
                <div className="fixed inset-0 z-50 bg-bg flex flex-col items-center justify-center">
                    <div className="w-24 h-24 rounded-2xl bg-gradient-to-br from-surfaceHighlight to-black border border-gold/30 flex items-center justify-center mb-6 animate-pulse-gold">
                        <Icon name="scissors" size={48} className="text-gold" />
                    </div>
                    <h1 className="text-4xl font-extrabold text-white tracking-wide">Line Free <span className="text-gold">India</span></h1>
                </div>
            );
        };

        // --- AUTH ---
        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen bg-bg p-6 flex flex-col justify-end pb-16 relative overflow-hidden">
                <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=800&q=80')] bg-cover opacity-20"></div>
                <div className="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
                
                <div className="relative z-10 mb-8">
                    <h1 className="text-5xl font-bold text-white mb-2">Queue Less.<br/><span className="text-gold">Live More.</span></h1>
                    <p className="text-gray-400">India's Smartest Salon Booking App.</p>
                </div>
                <button onClick={onLogin} className="relative z-10 w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-3 hover:scale-[1.02] transition-transform">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5"/>
                    Continue with Google
                </button>
            </div>
        );

        const RoleSelection = ({ onSelect }) => (
            <div className="min-h-screen bg-bg p-6 pt-24 animate-slide-up">
                <h2 className="text-3xl font-bold text-white mb-8">Select Profile</h2>
                <div className="space-y-4">
                    <button onClick={() => onSelect('customer')} className="w-full bg-surfaceHighlight p-6 rounded-2xl border border-white/5 flex items-center gap-4 hover:border-gold/50 transition-all text-left group">
                        <div className="p-4 bg-surface rounded-full text-white group-hover:text-gold transition-colors"><Icon name="user" size={32} /></div>
                        <div>
                            <h3 className="text-xl font-bold text-white">Customer</h3>
                            <p className="text-gray-400 text-sm">Book appointments & track queue.</p>
                        </div>
                    </button>
                    <button onClick={() => onSelect('owner')} className="w-full bg-surfaceHighlight p-6 rounded-2xl border border-white/5 flex items-center gap-4 hover:border-gold/50 transition-all text-left group">
                        <div className="p-4 bg-surface rounded-full text-white group-hover:text-gold transition-colors"><Icon name="store" size={32} /></div>
                        <div>
                            <h3 className="text-xl font-bold text-white">Salon Owner</h3>
                            <p className="text-gray-400 text-sm">Manage shop, staff & revenue.</p>
                        </div>
                    </button>
                </div>
            </div>
        );

        // --- SHOP SETUP (NEW) ---
        const ShopSetup = ({ onSave }) => {
            const [name, setName] = useState('');
            const [loc, setLoc] = useState('');
            const [img, setImg] = useState('https://images.unsplash.com/photo-1521590832896-7ea20ade7d60?w=800&q=80');

            const detectLocation = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        setLoc(`Lat: ${pos.coords.latitude.toFixed(4)}, Long: ${pos.coords.longitude.toFixed(4)}`);
                    });
                } else alert("Geo not supported");
            };

            return (
                <div className="min-h-screen bg-bg p-6 pt-12 animate-slide-up">
                    <h2 className="text-2xl font-bold text-white mb-6">Setup Your Salon</h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="text-xs text-gold font-bold uppercase">Shop Name</label>
                            <input value={name} onChange={e=>setName(e.target.value)} className="w-full bg-surfaceHighlight border border-white/10 rounded-xl p-4 mt-1 text-white outline-none focus:border-gold" placeholder="e.g. Royal Cuts" />
                        </div>
                        
                        <div>
                            <label className="text-xs text-gold font-bold uppercase">Location</label>
                            <div className="flex gap-2 mt-1">
                                <input value={loc} onChange={e=>setLoc(e.target.value)} className="flex-1 bg-surfaceHighlight border border-white/10 rounded-xl p-4 text-white outline-none" placeholder="City, Area" />
                                <button onClick={detectLocation} className="bg-surfaceHighlight border border-white/10 p-4 rounded-xl text-gold"><Icon name="map-pin" /></button>
                            </div>
                        </div>

                        <div>
                            <label className="text-xs text-gold font-bold uppercase">Shop Image URL</label>
                            <input value={img} onChange={e=>setImg(e.target.value)} className="w-full bg-surfaceHighlight border border-white/10 rounded-xl p-4 mt-1 text-white outline-none" />
                            <img src={img} className="w-full h-32 object-cover rounded-xl mt-2 opacity-60" />
                        </div>

                        <button onClick={() => onSave({name, loc, img})} disabled={!name} className="w-full bg-gold text-black font-bold py-4 rounded-xl mt-4 disabled:opacity-50">Launch Business ðŸš€</button>
                    </div>
                </div>
            );
        };

        // --- OWNER DASHBOARD ---
        const OwnerDashboard = ({ user, onReset }) => {
            const [view, setView] = useState('dashboard');
            const [salon, setSalon] = useState(null);
            const [queue, setQueue] = useState([]);
            const [isSetup, setIsSetup] = useState(true);

            useEffect(() => {
                const salonRef = doc(db, "salons", user.uid);
                const unsubSalon = onSnapshot(salonRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSalon(docSnap.data());
                        if (!docSnap.data().shopName) setIsSetup(false);
                    } else {
                        setIsSetup(false); 
                    }
                });

                const q = query(collection(db, "tokens"), where("salonId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubQueue = onSnapshot(q, (qs) => setQueue(qs.docs.map(d => ({id:d.id, ...d.data()}))));

                return () => { unsubSalon(); unsubQueue(); }
            }, [user]);

            useEffect(() => { if(view) lucide.createIcons(); });

            const handleSetupSave = async (data) => {
                await setDoc(doc(db, "salons", user.uid), {
                    shopName: data.name,
                    address: data.loc,
                    shopImage: data.img,
                    ownerName: user.displayName,
                    status: 'open',
                    revenue: 0,
                    totalTokens: 0,
                    rating: 5.0,
                    createdAt: serverTimestamp()
                });
                setIsSetup(true);
            };

            const toggleStatus = async () => updateDoc(doc(db, "salons", user.uid), {status: salon?.status==='open'?'closed':'open'});
            
            const callNext = async () => {
                const next = queue.find(t => t.status === 'waiting');
                if(next) await updateDoc(doc(db, "tokens", next.id), {status: 'serving'});
                const current = queue.find(t => t.status === 'serving');
                if(current) await updateDoc(doc(db, "tokens", current.id), {status: 'completed'});
            };

            if (!isSetup) return <ShopSetup onSave={handleSetupSave} />;

            return (
                <div className="min-h-screen bg-bg pb-24">
                    <div className="relative h-64">
                        <img src={salon?.shopImage} className="w-full h-full object-cover opacity-60" />
                        <div className="absolute inset-0 bg-gradient-to-t from-bg to-transparent"></div>
                        <div className="absolute bottom-4 left-6">
                            <h1 className="text-3xl font-bold text-white">{salon?.shopName}</h1>
                            <p className="text-sm text-gray-300 flex items-center gap-1"><Icon name="map-pin" size={14}/> {salon?.address}</p>
                        </div>
                    </div>

                    <div className="p-6 -mt-6 relative z-10 space-y-6">
                         {/* Status */}
                         <div className="bg-surfaceHighlight p-6 rounded-2xl flex justify-between items-center border border-white/5">
                            <div>
                                <p className="text-xs text-gray-500 uppercase font-bold">Status</p>
                                <div className="flex items-center gap-2">
                                    <div className={`w-2 h-2 rounded-full ${salon?.status === 'open' ? 'bg-success animate-pulse' : 'bg-danger'}`}></div>
                                    <span className="text-xl font-bold text-white capitalize">{salon?.status}</span>
                                </div>
                            </div>
                            <button onClick={toggleStatus} className="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm font-bold hover:bg-white/10">{salon?.status==='open'?'Close':'Open'}</button>
                         </div>

                         {/* Active Queue */}
                         <div className="bg-gold p-6 rounded-2xl text-black">
                             <p className="text-xs font-bold uppercase opacity-60 mb-2">Serving Now</p>
                             <div className="text-3xl font-black mb-1">{queue.find(t=>t.status==='serving')?.tokenNumber || '-'}</div>
                             <div className="font-bold mb-4">{queue.find(t=>t.status==='serving')?.userName || 'Empty'}</div>
                             <button onClick={callNext} className="w-full bg-black text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">Call Next <Icon name="arrow-right" size={16}/></button>
                         </div>

                         {/* Reset Button (For Testing) */}
                         <button onClick={onReset} className="w-full py-4 text-danger text-sm font-bold border border-danger/20 rounded-xl hover:bg-danger/10">Delete Account & Reset Demo</button>
                    </div>
                </div>
            );
        };

        // --- CUSTOMER DASHBOARD ---
        const CustomerDashboard = ({ user, onReset }) => {
            const [salons, setSalons] = useState([]);
            const [myToken, setMyToken] = useState(null);

            useEffect(() => {
                const unsubS = onSnapshot(collection(db, "salons"), s => setSalons(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const q = query(collection(db, "tokens"), where("userId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubT = onSnapshot(q, s => setMyToken(!s.empty ? {id:s.docs[0].id, ...s.docs[0].data()} : null));
                return () => { unsubS(); unsubT(); }
            }, [user]);

            useEffect(() => lucide.createIcons());

            const joinQueue = async (salon) => {
                await runTransaction(db, async (transaction) => {
                    const salonRef = doc(db, "salons", salon.id);
                    const sDoc = await transaction.get(salonRef);
                    if (!sDoc.exists()) throw "Error";
                    
                    const newTokenNum = (sDoc.data().totalTokens || 0) + 1;
                    transaction.update(salonRef, { totalTokens: newTokenNum });
                    
                    const tokenRef = doc(collection(db, "tokens"));
                    transaction.set(tokenRef, {
                        userId: user.uid, userName: user.displayName, salonId: salon.id, salonName: salon.shopName,
                        tokenNumber: newTokenNum, status: 'waiting', createdAt: serverTimestamp()
                    });
                });
                
                // Confetti
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            };

            const cancelToken = async () => {
                if(myToken) await updateDoc(doc(db, "tokens", myToken.id), {status: 'cancelled'});
            };

            return (
                <div className="min-h-screen bg-bg p-6 pb-24">
                    <div className="flex justify-between items-center mb-8 sticky top-0 bg-bg z-20 py-4">
                        <h1 className="text-2xl font-bold text-white">Line Free <span className="text-gold">India</span></h1>
                        <img src={user.photoURL} className="w-8 h-8 rounded-full border border-gold/30" />
                    </div>

                    {/* Active Token Card */}
                    {myToken && (
                        <div className="bg-gradient-to-br from-surfaceHighlight to-surface border border-gold/30 p-6 rounded-3xl mb-8 relative overflow-hidden animate-slide-up shadow-2xl shadow-gold/10">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gold"></div>
                            <div className="text-center">
                                <p className="text-xs text-gold font-bold uppercase tracking-widest mb-2">Live Token</p>
                                <h1 className="text-6xl font-black text-white">{myToken.tokenNumber}</h1>
                                <p className="text-gray-400 mt-2">{myToken.salonName}</p>
                                <div className="mt-6 pt-6 border-t border-white/10 flex justify-between">
                                    <div className="text-center w-1/2 border-r border-white/10">
                                        <div className="text-xl font-bold text-white">15m</div>
                                        <div className="text-[10px] text-gray-500 uppercase">Wait</div>
                                    </div>
                                    <div className="text-center w-1/2">
                                        <button onClick={cancelToken} className="text-danger text-sm font-bold">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <h2 className="text-lg font-bold text-white mb-4">Nearby Salons</h2>
                    <div className="space-y-4">
                        {salons.map(s => (
                            <div key={s.id} className="bg-surfaceHighlight p-4 rounded-2xl border border-white/5 flex gap-4 cursor-pointer hover:border-gold/30 transition-all">
                                <img src={s.shopImage} className="w-20 h-20 rounded-xl object-cover bg-gray-800" />
                                <div className="flex-1">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-white">{s.shopName}</h3>
                                        <span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded ${s.status === 'open' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>{s.status}</span>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1 flex items-center gap-1"><Icon name="map-pin" size={10}/> {s.address}</p>
                                    <button onClick={() => joinQueue(s)} disabled={myToken || s.status !== 'open'} className="mt-3 bg-white text-black text-xs font-bold py-2 px-4 rounded-lg hover:bg-gold transition-colors disabled:opacity-50">
                                        {myToken ? 'Already in Queue' : 'Join Queue'}
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="mt-12 pt-8 border-t border-white/5">
                        <button onClick={onReset} className="w-full text-center text-xs text-gray-600 hover:text-danger">Reset Account (Demo)</button>
                    </div>
                </div>
            );
        };

        // --- ROOT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [loading, setLoading] = useState(true);
            const [splash, setSplash] = useState(true);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if (u) {
                        const snap = await getDoc(doc(db, "users", u.uid));
                        if (snap.exists()) setRole(snap.data().role);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleLogin = () => signInWithPopup(auth, googleProvider);
            const handleRoleSelect = async (r) => {
                await setDoc(doc(db, "users", user.uid), { role: r, email: user.email, name: user.displayName, photoURL: user.photoURL, createdAt: serverTimestamp() });
                setRole(r);
            };

            const resetAccount = async () => {
                if(confirm("Are you sure? This will delete your profile.")) {
                    // In real app, cloud function handles cleanup. Here we just clear local doc ref logic
                    await deleteDoc(doc(db, "users", user.uid));
                    // Also try to delete salon if owner
                    await deleteDoc(doc(db, "salons", user.uid));
                    setRole(null);
                    window.location.reload();
                }
            };

            if (splash) return <SplashScreen onFinish={() => setSplash(false)} />;
            if (loading) return null;

            return !user ? <LoginScreen onLogin={handleLogin} /> : 
                   !role ? <RoleSelection onSelect={handleRoleSelect} /> : 
                   role === 'owner' ? <OwnerDashboard user={user} onReset={resetAccount} /> : <CustomerDashboard user={user} onReset={resetAccount} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


