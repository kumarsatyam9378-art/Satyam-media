<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Free India - Diamond</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        surface: '#0F0F0F',
                        surfaceLight: '#1C1C1E',
                        surfaceLighter: '#2C2C2E',
                        primary: '#FFD700', // Gold
                        primaryDim: '#C5A000',
                        accent: '#0A84FF',
                        danger: '#FF453A',
                        success: '#30D158',
                        textMain: '#FFFFFF',
                        textSec: '#9CA3AF',
                        border: 'rgba(255, 255, 255, 0.1)'
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 10px rgba(255, 215, 0, 0.1)' }, '50%': { boxShadow: '0 0 25px rgba(255, 215, 0, 0.3)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #000000; color: #ffffff; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, where, orderBy, updateDoc, serverTimestamp, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYJq8T7hMP3OsZ0PYqkWe-dDCWB8_b0Ck",
            authDomain: "line-free-4bb96.firebaseapp.com",
            projectId: "line-free-4bb96",
            storageBucket: "line-free-4bb96.firebasestorage.app",
            messagingSenderId: "137966607796",
            appId: "1:137966607796:web:bc84b4884650911d9ea6e1",
            measurementId: "G-6Z6YQ8Z6CC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const Icon = ({ name, size = 20, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        // --- COMPONENTS ---

        // 1. BOTTOM NAVIGATION
        const BottomNav = ({ activeTab, onTabChange, role }) => (
            <div className="fixed bottom-0 w-full glass pb-6 pt-4 px-8 flex justify-between items-center z-50">
                <button onClick={() => onTabChange('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-primary scale-110' : 'text-textSec'}`}>
                    <Icon name="home" size={24} />
                    <span className="text-[10px] font-bold">Home</span>
                </button>
                {role === 'owner' ? (
                    <button onClick={() => onTabChange('services')} className={`flex flex-col items-center gap-1 ${activeTab === 'services' ? 'text-primary scale-110' : 'text-textSec'}`}>
                        <Icon name="list" size={24} />
                        <span className="text-[10px] font-bold">Menu</span>
                    </button>
                ) : (
                    <button onClick={() => onTabChange('activity')} className={`flex flex-col items-center gap-1 ${activeTab === 'activity' ? 'text-primary scale-110' : 'text-textSec'}`}>
                        <Icon name="ticket" size={24} />
                        <span className="text-[10px] font-bold">Activity</span>
                    </button>
                )}
                <button onClick={() => onTabChange('profile')} className={`flex flex-col items-center gap-1 ${activeTab === 'profile' ? 'text-primary scale-110' : 'text-textSec'}`}>
                    <Icon name="user" size={24} />
                    <span className="text-[10px] font-bold">Profile</span>
                </button>
            </div>
        );

        // 2. PROFILE SCREEN (Common)
        const ProfileScreen = ({ user, role, onLogout }) => (
            <div className="p-6 pb-24 animate-slide-up">
                <h2 className="text-2xl font-bold text-white mb-8">My Profile</h2>
                <div className="flex items-center gap-4 mb-8 bg-surfaceLight p-4 rounded-2xl border border-white/5">
                    <img src={user.photoURL} className="w-16 h-16 rounded-full border-2 border-primary" />
                    <div>
                        <h3 className="text-lg font-bold text-white">{user.displayName}</h3>
                        <p className="text-textSec text-sm">{user.email}</p>
                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-primary/20 text-primary mt-2">{role}</span>
                    </div>
                </div>

                <div className="space-y-3">
                    <div className="bg-surfaceLight p-4 rounded-xl border border-white/5 flex justify-between items-center cursor-pointer hover:bg-white/5">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-black/30 rounded-lg text-primary"><Icon name="wallet" size={20}/></div>
                            <span className="font-bold text-white">Wallet</span>
                        </div>
                        <span className="text-textSec">₹0.00</span>
                    </div>
                    <div className="bg-surfaceLight p-4 rounded-xl border border-white/5 flex justify-between items-center cursor-pointer hover:bg-white/5">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-black/30 rounded-lg text-accent"><Icon name="bell" size={20}/></div>
                            <span className="font-bold text-white">Notifications</span>
                        </div>
                        <div className="w-2 h-2 bg-danger rounded-full"></div>
                    </div>
                    <div className="bg-surfaceLight p-4 rounded-xl border border-white/5 flex justify-between items-center cursor-pointer hover:bg-white/5">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-black/30 rounded-lg text-success"><Icon name="help-circle" size={20}/></div>
                            <span className="font-bold text-white">Help & Support</span>
                        </div>
                        <Icon name="chevron-right" size={16} className="text-textSec"/>
                    </div>
                </div>

                <button onClick={onLogout} className="w-full mt-8 py-4 rounded-xl bg-danger/10 text-danger font-bold flex items-center justify-center gap-2 hover:bg-danger/20 transition-all border border-danger/20">
                    <Icon name="log-out" size={20} /> Logout
                </button>
                <p className="text-center text-xs text-textSec mt-4">Version 2.0.0 (Diamond)</p>
            </div>
        );

        // 3. OWNER DASHBOARD
        const OwnerDashboard = ({ user, onLogout }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [salon, setSalon] = useState(null);
            const [queue, setQueue] = useState([]);
            const [services, setServices] = useState([]);
            
            // SETUP STATE
            const [setupName, setSetupName] = useState('');
            const [setupLoc, setSetupLoc] = useState('');
            const [setupImg, setSetupImg] = useState('https://images.unsplash.com/photo-1521590832896-7ea20ade7d60?w=800&q=80');

            useEffect(() => {
                const unsubSalon = onSnapshot(doc(db, "salons", user.uid), (docSnap) => {
                    if(docSnap.exists()) {
                        setSalon(docSnap.data());
                        setServices(docSnap.data().services || []);
                    }
                });

                const q = query(collection(db, "tokens"), where("salonId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubQueue = onSnapshot(q, (s) => setQueue(s.docs.map(d => ({id:d.id, ...d.data()}))));

                return () => { unsubSalon(); unsubQueue(); }
            }, [user]);

            useEffect(() => { lucide.createIcons(); });

            const handleSetup = async () => {
                await setDoc(doc(db, "salons", user.uid), {
                    shopName: setupName, address: setupLoc, shopImage: setupImg,
                    ownerName: user.displayName, status: 'open', revenue: 0, rating: 5.0, totalTokensToday: 0,
                    services: [
                        { name: 'Haircut', price: 200, time: 30 },
                        { name: 'Shave', price: 100, time: 15 }
                    ],
                    createdAt: serverTimestamp()
                });
            };

            const callNext = async () => {
                const waiting = queue.filter(t => t.status === 'waiting').sort((a,b) => a.tokenNumber - b.tokenNumber);
                const serving = queue.find(t => t.status === 'serving');

                if(serving) await updateDoc(doc(db, "tokens", serving.id), {status: 'completed'});
                if(waiting.length > 0) await updateDoc(doc(db, "tokens", waiting[0].id), {status: 'serving'});
            };

            // Setup Screen
            if(!salon) {
                return (
                    <div className="min-h-screen bg-bg p-6 pt-12 animate-slide-up">
                        <h2 className="text-3xl font-bold text-white mb-6">Setup Business</h2>
                        <div className="space-y-4">
                            <input value={setupName} onChange={e=>setSetupName(e.target.value)} placeholder="Shop Name" className="w-full bg-surfaceLight border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary" />
                            <input value={setupLoc} onChange={e=>setSetupLoc(e.target.value)} placeholder="City" className="w-full bg-surfaceLight border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary" />
                            <button onClick={handleSetup} disabled={!setupName} className="w-full bg-primary text-black font-bold py-4 rounded-xl disabled:opacity-50">Launch Business</button>
                        </div>
                    </div>
                );
            }

            const current = queue.find(t => t.status === 'serving');

            return (
                <div className="min-h-screen bg-bg">
                    {activeTab === 'home' && (
                        <div className="pb-24">
                            <div className="h-64 relative">
                                <img src={salon?.shopImage} className="w-full h-full object-cover opacity-60" />
                                <div className="absolute inset-0 bg-gradient-to-t from-bg to-transparent"></div>
                                <div className="absolute bottom-4 left-6">
                                    <h1 className="text-3xl font-bold text-white">{salon?.shopName}</h1>
                                    <p className="text-gray-400 text-sm">{salon?.address}</p>
                                </div>
                            </div>

                            <div className="p-6 -mt-6 relative z-10 space-y-4">
                                <div className="bg-surfaceLight p-4 rounded-xl border border-white/5 flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <div className={`w-3 h-3 rounded-full ${salon?.status==='open' ? 'bg-success animate-pulse' : 'bg-danger'}`}></div>
                                        <span className="font-bold text-white capitalize">{salon?.status}</span>
                                    </div>
                                    <button onClick={()=>updateDoc(doc(db, "salons", user.uid), {status: salon?.status==='open'?'closed':'open'})} className="bg-white/10 px-4 py-2 rounded-lg text-xs font-bold">Toggle</button>
                                </div>

                                <div className="bg-primary p-6 rounded-3xl text-black shadow-lg shadow-primary/20">
                                    <p className="text-xs font-bold uppercase opacity-60 mb-2">Now Serving</p>
                                    <div className="flex justify-between items-end mb-6">
                                        <div>
                                            <h2 className="text-5xl font-black">{current ? current.tokenNumber : '-'}</h2>
                                            <p className="font-bold mt-1">{current ? current.userName : 'Empty Queue'}</p>
                                        </div>
                                        <div className="w-12 h-12 bg-black/10 rounded-full flex items-center justify-center"><Icon name="mic" /></div>
                                    </div>
                                    <button onClick={callNext} className="w-full bg-black text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">Call Next <Icon name="arrow-right" size={18}/></button>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-surfaceLight p-4 rounded-2xl border border-white/5 text-center">
                                        <h3 className="text-2xl font-bold text-white">{queue.filter(t=>t.status==='waiting').length}</h3>
                                        <p className="text-xs text-textSec uppercase">Waiting</p>
                                    </div>
                                    <div className="bg-surfaceLight p-4 rounded-2xl border border-white/5 text-center">
                                        <h3 className="text-2xl font-bold text-white">₹{salon?.revenue || 0}</h3>
                                        <p className="text-xs text-textSec uppercase">Revenue</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'services' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Manage Menu</h2>
                            <div className="space-y-3">
                                {services.map((s, i) => (
                                    <div key={i} className="flex justify-between items-center bg-surfaceLight p-4 rounded-xl border border-white/5">
                                        <div>
                                            <h4 className="font-bold text-white">{s.name}</h4>
                                            <p className="text-xs text-textSec">{s.time} mins</p>
                                        </div>
                                        <span className="font-bold text-primary">₹{s.price}</span>
                                    </div>
                                ))}
                                {services.length === 0 && <p className="text-textSec text-center">No services added.</p>}
                            </div>
                        </div>
                    )}

                    {activeTab === 'profile' && <ProfileScreen user={user} role="Owner" onLogout={onLogout} />}

                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} role="owner" />
                </div>
            );
        };

        // 5. CUSTOMER DASHBOARD
        const CustomerDashboard = ({ user, onLogout }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [salons, setSalons] = useState([]);
            const [activeToken, setActiveToken] = useState(null);

            useEffect(() => {
                const unsubS = onSnapshot(collection(db, "salons"), s => setSalons(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const q = query(collection(db, "tokens"), where("userId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubT = onSnapshot(q, s => setActiveToken(!s.empty ? {id:s.docs[0].id, ...s.docs[0].data()} : null));
                return () => { unsubS(); unsubT(); }
            }, [user]);

            useEffect(() => lucide.createIcons());

            const joinQueue = async (salon) => {
                if(activeToken) return alert("Already in queue!");
                await runTransaction(db, async (t) => {
                    const sRef = doc(db, "salons", salon.id);
                    const sDoc = await t.get(sRef);
                    const newToken = (sDoc.data().totalTokensToday || 0) + 1;
                    t.update(sRef, { totalTokensToday: newToken });
                    const tRef = doc(collection(db, "tokens"));
                    t.set(tRef, {
                        userId: user.uid, userName: user.displayName, salonId: salon.id, salonName: salon.shopName,
                        tokenNumber: newToken, status: 'waiting', createdAt: serverTimestamp()
                    });
                });
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                setActiveTab('activity');
            };

            return (
                <div className="min-h-screen bg-bg">
                    {activeTab === 'home' && (
                        <div className="p-6 pb-24">
                            <div className="flex justify-between items-center mb-6 sticky top-0 bg-bg z-20 py-4 border-b border-white/5">
                                <h1 className="text-xl font-bold text-white">Line Free <span className="text-primary">India</span></h1>
                                <img src={user.photoURL} className="w-8 h-8 rounded-full border border-primary/50" />
                            </div>
                            <h2 className="text-lg font-bold text-white mb-4">Nearby Salons</h2>
                            <div className="space-y-4">
                                {salons.map(s => (
                                    <div key={s.id} className="bg-surfaceLight p-4 rounded-2xl border border-white/5 flex gap-4 active:scale-[0.98] transition-transform">
                                        <img src={s.shopImage} className="w-20 h-20 rounded-xl object-cover bg-gray-800" />
                                        <div className="flex-1">
                                            <div className="flex justify-between items-start">
                                                <h3 className="font-bold text-white">{s.shopName}</h3>
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${s.status==='open'?'bg-success/10 text-success':'bg-danger/10 text-danger'}`}>{s.status}</span>
                                            </div>
                                            <p className="text-xs text-gray-400 mt-1 flex items-center gap-1"><Icon name="map-pin" size={10}/> {s.address}</p>
                                            <button onClick={()=>joinQueue(s)} disabled={s.status!=='open' || activeToken} className="mt-3 bg-white text-black text-xs font-bold py-2.5 w-full rounded-lg hover:bg-primary transition-colors disabled:opacity-50">
                                                {activeToken ? 'Already Booked' : 'Join Queue'}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'activity' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Activity</h2>
                            {activeToken ? (
                                <div className="bg-surfaceLight border border-primary/40 p-6 rounded-[2rem] mb-8 relative overflow-hidden animate-slide-up shadow-[0_0_20px_rgba(255,215,0,0.1)]">
                                    <div className="text-center">
                                        <p className="text-xs text-primary font-bold uppercase tracking-widest mb-1 animate-pulse">Live Status</p>
                                        <h1 className="text-6xl font-black text-white tracking-tighter">{activeToken.tokenNumber}</h1>
                                        <p className="text-gray-400 mt-1 text-sm">{activeToken.salonName}</p>
                                        <button onClick={()=>updateDoc(doc(db, "tokens", activeToken.id), {status: 'cancelled'})} className="mt-4 text-danger text-xs font-bold border border-danger/20 px-4 py-2 rounded-lg hover:bg-danger/10">Cancel Token</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center py-20 text-textSec">No active bookings.</div>
                            )}
                        </div>
                    )}

                    {activeTab === 'profile' && <ProfileScreen user={user} role="Customer" onLogout={onLogout} />}

                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} role="customer" />
                </div>
            );
        };

        // 6. SPLASH & AUTH
        const SplashScreen = () => {
            useEffect(() => lucide.createIcons());
            return (
                <div className="fixed inset-0 z-50 bg-black flex items-center justify-center">
                    <div className="text-primary font-bold text-2xl tracking-widest animate-pulse">LINE FREE</div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen bg-bg p-6 flex flex-col justify-end pb-16">
                <div className="mb-10 animate-slide-up">
                    <div className="w-16 h-16 rounded-2xl glass border border-primary/20 flex items-center justify-center mb-6">
                        <Icon name="crown" size={32} className="text-primary" />
                    </div>
                    <h1 className="text-5xl font-bold text-white mb-2 leading-tight">Ready.<br/><span className="text-primary">Set. Go.</span></h1>
                    <p className="text-textSec text-lg">Queue Less. Live More.</p>
                </div>
                <button onClick={onLogin} className="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition-transform active:scale-95 shadow-xl hover:bg-gray-100 animate-slide-up">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6"/>
                    Continue with Google
                </button>
            </div>
        );

        const RoleSelection = ({ onSelect }) => (
            <div className="min-h-screen bg-bg p-6 pt-24 animate-slide-up">
                <h2 className="text-3xl font-bold text-white mb-2">Who are you?</h2>
                <div className="space-y-4 mt-8">
                    <button onClick={() => onSelect('customer')} className="w-full bg-surfaceLight p-6 rounded-2xl border border-white/5 flex items-center gap-5 hover:border-primary/50 transition-all text-left">
                        <div className="w-12 h-12 bg-surface rounded-full flex items-center justify-center text-white border border-white/5"><Icon name="user" size={24} /></div>
                        <div>
                            <h3 className="text-lg font-bold text-white">Customer</h3>
                            <p className="text-textSec text-xs mt-1">Book services instantly.</p>
                        </div>
                    </button>
                    <button onClick={() => onSelect('owner')} className="w-full bg-surfaceLight p-6 rounded-2xl border border-white/5 flex items-center gap-5 hover:border-primary/50 transition-all text-left">
                        <div className="w-12 h-12 bg-surface rounded-full flex items-center justify-center text-white border border-white/5"><Icon name="store" size={24} /></div>
                        <div>
                            <h3 className="text-lg font-bold text-white">Salon Owner</h3>
                            <p className="text-textSec text-xs mt-1">Manage your business.</p>
                        </div>
                    </button>
                </div>
            </div>
        );

        // --- ROOT APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if (u) {
                        const snap = await getDoc(doc(db, "users", u.uid));
                        if (snap.exists()) setRole(snap.data().role);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleLogin = () => signInWithPopup(auth, googleProvider);
            const handleRoleSelect = async (r) => {
                await setDoc(doc(db, "users", user.uid), { role: r, email: user.email, name: user.displayName, photoURL: user.photoURL, createdAt: serverTimestamp() });
                setRole(r);
            };
            const handleLogout = () => signOut(auth);

            if (loading) return <SplashScreen />;

            return !user ? <LoginScreen onLogin={handleLogin} /> : 
                   !role ? <RoleSelection onSelect={handleRoleSelect} /> : 
                   role === 'owner' ? <OwnerDashboard user={user} onLogout={handleLogout} /> : <CustomerDashboard user={user} onLogout={handleLogout} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
