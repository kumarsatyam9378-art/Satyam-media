<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Free India - Ultimate Business</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        surface: '#0F0F0F',
                        surfaceLight: '#1C1C1E',
                        surfaceLighter: '#2C2C2E',
                        primary: '#FFD700', // Gold
                        primaryDim: '#C5A000',
                        accent: '#0A84FF',
                        danger: '#FF453A',
                        success: '#30D158',
                        warning: '#FF9F0A',
                        textMain: '#FFFFFF',
                        textSec: '#9CA3AF',
                        border: 'rgba(255, 255, 255, 0.1)'
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pop': 'pop 0.2s ease-out forwards',
                    },
                    keyframes: {
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 10px rgba(255, 215, 0, 0.1)' }, '50%': { boxShadow: '0 0 25px rgba(255, 215, 0, 0.3)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #000000; color: #ffffff; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, where, orderBy, updateDoc, serverTimestamp, deleteDoc, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYJq8T7hMP3OsZ0PYqkWe-dDCWB8_b0Ck",
            authDomain: "line-free-4bb96.firebaseapp.com",
            projectId: "line-free-4bb96",
            storageBucket: "line-free-4bb96.firebasestorage.app",
            messagingSenderId: "137966607796",
            appId: "1:137966607796:web:bc84b4884650911d9ea6e1",
            measurementId: "G-6Z6YQ8Z6CC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // --- UTILS ---
        const Icon = ({ name, size = 20, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        const getDistance = (lat1, lon1, lat2, lon2) => {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        };

        // --- COMPONENTS ---

        // 1. BOTTOM NAV (Common for both but different tabs)
        const BottomNav = ({ activeTab, onTabChange, role }) => (
            <div className="fixed bottom-0 w-full glass pb-6 pt-4 px-4 flex justify-around items-center z-50 transition-all">
                {role === 'customer' ? (
                    <>
                        <button onClick={() => onTabChange('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                            <Icon name="home" size={24} />
                            <span className="text-[10px] font-bold">Salons</span>
                        </button>
                        <button onClick={() => onTabChange('favorites')} className={`flex flex-col items-center gap-1 ${activeTab === 'favorites' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                            <Icon name="heart" size={24} />
                            <span className="text-[10px] font-bold">Favorites</span>
                        </button>
                        <button onClick={() => onTabChange('subscription')} className={`flex flex-col items-center gap-1 ${activeTab === 'subscription' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                            <Icon name="crown" size={24} />
                            <span className="text-[10px] font-bold">Plan</span>
                        </button>
                    </>
                ) : (
                    <>
                        <button onClick={() => onTabChange('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                            <Icon name="layout-dashboard" size={24} />
                            <span className="text-[10px] font-bold">Control</span>
                        </button>
                        <button onClick={() => onTabChange('services')} className={`flex flex-col items-center gap-1 ${activeTab === 'services' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                            <Icon name="list" size={24} />
                            <span className="text-[10px] font-bold">Menu</span>
                        </button>
                        <button onClick={() => onTabChange('qr')} className={`flex flex-col items-center gap-1 ${activeTab === 'qr' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                            <Icon name="qr-code" size={24} />
                            <span className="text-[10px] font-bold">QR</span>
                        </button>
                    </>
                )}
                
                {/* Common Profile Tab */}
                <button onClick={() => onTabChange('profile')} className={`flex flex-col items-center gap-1 ${activeTab === 'profile' ? 'text-primary scale-110' : 'text-textSec'} transition-all`}>
                    <Icon name="user" size={24} />
                    <span className="text-[10px] font-bold">Profile</span>
                </button>
            </div>
        );

        // 2. PROFILE SCREEN (Common)
        const ProfileScreen = ({ user, role, onLogout, onSwitchRole }) => (
            <div className="p-6 pb-24 animate-slide-up bg-bg min-h-screen">
                <h2 className="text-2xl font-bold text-white mb-8">My Profile</h2>
                <div className="flex items-center gap-4 mb-8 bg-surfaceLight p-4 rounded-2xl border border-white/5 shadow-lg">
                    <img src={user.photoURL} className="w-16 h-16 rounded-full border-2 border-primary" />
                    <div>
                        <h3 className="text-lg font-bold text-white">{user.displayName}</h3>
                        <p className="text-textSec text-sm">{user.email}</p>
                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-primary/20 text-primary mt-2">{role}</span>
                    </div>
                </div>

                <div className="space-y-4">
                    <button onClick={onSwitchRole} className="w-full bg-white/5 p-4 rounded-xl border border-white/5 flex justify-between items-center hover:bg-white/10 transition-all group">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-primary rounded-lg text-black"><Icon name="refresh-cw" size={20}/></div>
                            <div className="text-left">
                                <span className="font-bold text-white block">Switch Profile</span>
                                <span className="text-xs text-textSec">Change between Owner/Customer</span>
                            </div>
                        </div>
                        <Icon name="chevron-right" size={16} className="text-textSec group-hover:text-white"/>
                    </button>

                    <div className="bg-surfaceLight p-4 rounded-xl border border-white/5 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-black/30 rounded-lg text-primary"><Icon name="wallet" size={20}/></div>
                            <span className="font-bold text-white">Wallet</span>
                        </div>
                        <span className="text-textSec">‚Çπ0.00</span>
                    </div>

                    <button onClick={onLogout} className="w-full mt-8 py-4 rounded-xl bg-danger/10 text-danger font-bold flex items-center justify-center gap-2 hover:bg-danger/20 transition-all border border-danger/20">
                        <Icon name="log-out" size={20} /> Logout
                    </button>
                </div>
            </div>
        );

        // 3. SUBSCRIPTION INFO SCREEN
        const SubscriptionScreen = () => (
            <div className="p-6 pb-24 animate-slide-up min-h-screen bg-bg flex flex-col items-center justify-center text-center">
                <div className="w-24 h-24 bg-gradient-to-br from-primary to-orange-500 rounded-full flex items-center justify-center mb-6 shadow-2xl shadow-primary/20 animate-pulse-glow">
                    <Icon name="crown" size={48} className="text-black" />
                </div>
                <h2 className="text-3xl font-black text-white mb-2">PRO MEMBER</h2>
                <p className="text-primary font-bold tracking-widest mb-8">FREE TRIAL ACTIVE</p>
                
                <div className="bg-surfaceLight p-6 rounded-3xl border border-white/10 w-full max-w-sm text-left">
                    <div className="flex items-center gap-3 mb-4">
                        <div className="bg-success/20 p-1 rounded-full"><Icon name="check" size={16} className="text-success" /></div>
                        <span className="text-sm text-gray-300">Priority Queue Access</span>
                    </div>
                    <div className="flex items-center gap-3 mb-4">
                        <div className="bg-success/20 p-1 rounded-full"><Icon name="check" size={16} className="text-success" /></div>
                        <span className="text-sm text-gray-300">Unlimited Bookings</span>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="bg-success/20 p-1 rounded-full"><Icon name="check" size={16} className="text-success" /></div>
                        <span className="text-sm text-gray-300">Ad-Free Experience</span>
                    </div>
                </div>
                <p className="text-xs text-textSec mt-8">Your free trial expires in 60 days. No Payment Required.</p>
            </div>
        );

        // 4. OWNER DASHBOARD
        const OwnerDashboard = ({ user, onLogout, onSwitchRole }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [salon, setSalon] = useState(null);
            const [queue, setQueue] = useState([]);
            const [services, setServices] = useState([]);
            
            // Edit Service State
            const [newSvcName, setNewSvcName] = useState('');
            const [newSvcPrice, setNewSvcPrice] = useState('');
            const [newSvcTime, setNewSvcTime] = useState('');

            // Setup State
            const [setupName, setSetupName] = useState('');
            const [setupAddress, setSetupAddress] = useState('');
            const [setupCoords, setSetupCoords] = useState(null);
            const [setupImg, setSetupImg] = useState('https://images.unsplash.com/photo-1521590832896-7ea20ade7d60?w=800&q=80');

            const PRESET_IMAGES = [
                'https://images.unsplash.com/photo-1521590832896-7ea20ade7d60?w=800&q=80',
                'https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=800&q=80',
                'https://images.unsplash.com/photo-1633681926022-84c23e8cb2d6?w=800&q=80',
                'https://images.unsplash.com/photo-1605497788044-5a32c7078486?w=800&q=80'
            ];

            useEffect(() => {
                const unsubSalon = onSnapshot(doc(db, "salons", user.uid), (docSnap) => {
                    if(docSnap.exists()) {
                        setSalon(docSnap.data());
                        setServices(docSnap.data().services || []);
                        if(docSnap.data().shopName) {
                            setSetupName(docSnap.data().shopName);
                            setSetupAddress(docSnap.data().address);
                            setSetupImg(docSnap.data().shopImage);
                        }
                        // DAILY RESET LOGIC
                        const today = new Date().toDateString();
                        if (docSnap.data().lastResetDate !== today) {
                            updateDoc(doc(db, "salons", user.uid), {
                                totalTokensToday: 0,
                                lastResetDate: today
                            });
                        }
                    }
                });

                const q = query(collection(db, "tokens"), where("salonId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubQueue = onSnapshot(q, (s) => setQueue(s.docs.map(d => ({id:d.id, ...d.data()}))));

                return () => { unsubSalon(); unsubQueue(); }
            }, [user]);

            useEffect(() => { lucide.createIcons(); });

            // Handlers
            const detectLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        setSetupCoords({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                        alert("Location Captured!");
                    }, () => alert("Permission denied"));
                }
            };

            const handleSetup = async () => {
                await setDoc(doc(db, "salons", user.uid), {
                    shopName: setupName, address: setupAddress, shopImage: setupImg, coordinates: setupCoords,
                    ownerName: user.displayName, status: 'open', revenue: 0, rating: 5.0, totalTokensToday: 0,
                    lastResetDate: new Date().toDateString(),
                    services: services.length ? services : [{ name: 'Haircut', price: 200, time: 30 }],
                    createdAt: serverTimestamp()
                });
            };

            const addService = async () => {
                if(!newSvcName || !newSvcPrice) return alert("Fill details");
                const newService = { name: newSvcName, price: parseInt(newSvcPrice), time: parseInt(newSvcTime) || 30 };
                const updated = [...services, newService];
                await updateDoc(doc(db, "salons", user.uid), { services: updated });
                setNewSvcName(''); setNewSvcPrice(''); setNewSvcTime('');
            };

            const deleteService = async (index) => {
                const updated = services.filter((_, i) => i !== index);
                await updateDoc(doc(db, "salons", user.uid), { services: updated });
            };

            const updateStatus = async (newStatus) => {
                await updateDoc(doc(db, "salons", user.uid), {status: newStatus});
            };

            const callNext = async () => {
                const waiting = queue.filter(t => t.status === 'waiting').sort((a,b) => a.tokenNumber - b.tokenNumber);
                const serving = queue.find(t => t.status === 'serving');
                if(serving) await updateDoc(doc(db, "tokens", serving.id), {status: 'completed'});
                if(waiting.length > 0) await updateDoc(doc(db, "tokens", waiting[0].id), {status: 'serving'});
            };

            // Setup View
            if(!salon || !salon.shopName) {
                return (
                    <div className="min-h-screen bg-bg p-6 pt-12 animate-slide-up pb-24">
                        <h2 className="text-3xl font-bold text-white mb-6">Setup Business</h2>
                        <div className="space-y-6">
                            <div>
                                <label className="text-xs text-primary font-bold uppercase block mb-2">Shop Name</label>
                                <input value={setupName} onChange={e=>setSetupName(e.target.value)} placeholder="e.g. Royal Cuts" className="w-full bg-surfaceLight border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary" />
                            </div>
                            <div>
                                <label className="text-xs text-primary font-bold uppercase block mb-2">Location</label>
                                <input value={setupAddress} onChange={e=>setSetupAddress(e.target.value)} placeholder="City, Area" className="w-full bg-surfaceLight border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary mb-2" />
                                <button onClick={detectLocation} className="flex items-center justify-center gap-2 w-full py-3 bg-white/10 rounded-xl text-primary text-sm font-bold border border-primary/20 hover:bg-primary/10">
                                    <Icon name="map-pin" size={16} /> {setupCoords ? "GPS Detected ‚úì" : "Detect GPS Location"}
                                </button>
                            </div>
                            <div>
                                <label className="text-xs text-primary font-bold uppercase block mb-2">Shop Image</label>
                                <div className="flex gap-2 overflow-x-auto pb-2">
                                    {PRESET_IMAGES.map((img, i) => (
                                        <img key={i} src={img} onClick={() => setSetupImg(img)} className={`w-16 h-16 rounded-lg object-cover cursor-pointer border-2 ${setupImg === img ? 'border-primary' : 'border-transparent'}`} />
                                    ))}
                                </div>
                                <img src={setupImg} className="w-full h-40 object-cover rounded-xl border border-white/10 mt-2" />
                            </div>
                            <button onClick={handleSetup} disabled={!setupName || !setupAddress} className="w-full bg-primary text-black font-bold py-4 rounded-xl disabled:opacity-50 mt-4">Launch Business üöÄ</button>
                        </div>
                    </div>
                );
            }

            const current = queue.find(t => t.status === 'serving');

            return (
                <div className="min-h-screen bg-bg">
                    {activeTab === 'home' && (
                        <div className="pb-24">
                            <div className="h-64 relative">
                                <img src={salon?.shopImage} className="w-full h-full object-cover opacity-60" />
                                <div className="absolute inset-0 bg-gradient-to-t from-bg to-transparent"></div>
                                <div className="absolute bottom-4 left-6">
                                    <h1 className="text-3xl font-bold text-white">{salon?.shopName}</h1>
                                    <p className="text-gray-400 text-sm flex items-center gap-1"><Icon name="map-pin" size={14}/> {salon?.address}</p>
                                </div>
                            </div>

                            <div className="p-6 -mt-6 relative z-10 space-y-4">
                                {/* Control Center */}
                                <div className="bg-surfaceLight p-4 rounded-xl border border-white/5">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="text-xs font-bold uppercase text-textSec">Shop Controls</span>
                                        <span className={`text-xs font-bold uppercase px-2 py-1 rounded ${salon.status === 'open' ? 'bg-success/20 text-success' : salon.status === 'break' ? 'bg-warning/20 text-warning' : 'bg-danger/20 text-danger'}`}>{salon.status}</span>
                                    </div>
                                    <div className="grid grid-cols-4 gap-2">
                                        <button onClick={()=>updateStatus('open')} className={`flex flex-col items-center gap-1 p-2 rounded-lg border ${salon.status === 'open' ? 'bg-success/20 border-success text-success' : 'bg-black/20 border-white/5 text-textSec'}`}><Icon name="unlock" size={20}/><span className="text-[8px] font-bold">OPEN</span></button>
                                        <button onClick={()=>updateStatus('closed')} className={`flex flex-col items-center gap-1 p-2 rounded-lg border ${salon.status === 'closed' ? 'bg-danger/20 border-danger text-danger' : 'bg-black/20 border-white/5 text-textSec'}`}><Icon name="lock" size={20}/><span className="text-[8px] font-bold">CLOSE</span></button>
                                        <button onClick={()=>updateStatus('break')} className={`flex flex-col items-center gap-1 p-2 rounded-lg border ${salon.status === 'break' ? 'bg-warning/20 border-warning text-warning' : 'bg-black/20 border-white/5 text-textSec'}`}><Icon name="coffee" size={20}/><span className="text-[8px] font-bold">BREAK</span></button>
                                        <button onClick={()=>updateStatus('stopped')} className={`flex flex-col items-center gap-1 p-2 rounded-lg border ${salon.status === 'stopped' ? 'bg-white/20 border-white text-white' : 'bg-black/20 border-white/5 text-textSec'}`}><Icon name="stop-circle" size={20}/><span className="text-[8px] font-bold">STOP</span></button>
                                    </div>
                                </div>

                                <div className="bg-primary p-6 rounded-3xl text-black shadow-lg shadow-primary/20">
                                    <p className="text-xs font-bold uppercase opacity-60 mb-2">Now Serving</p>
                                    <div className="flex justify-between items-end mb-6">
                                        <div>
                                            <h2 className="text-5xl font-black">{current ? current.tokenNumber : '-'}</h2>
                                            <p className="font-bold mt-1">{current ? current.userName : 'Empty Queue'}</p>
                                        </div>
                                        <div className="w-12 h-12 bg-black/10 rounded-full flex items-center justify-center"><Icon name="mic" /></div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={callNext} className="flex-1 bg-black text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">Next Customer <Icon name="arrow-right" size={18}/></button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-surfaceLight p-4 rounded-2xl border border-white/5 text-center">
                                        <h3 className="text-2xl font-bold text-white">{queue.filter(t=>t.status==='waiting').length}</h3>
                                        <p className="text-xs text-textSec uppercase">Waiting</p>
                                    </div>
                                    <div className="bg-surfaceLight p-4 rounded-2xl border border-white/5 text-center">
                                        <h3 className="text-2xl font-bold text-white">‚Çπ{salon?.revenue || 0}</h3>
                                        <p className="text-xs text-textSec uppercase">Revenue</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'services' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Manage Menu</h2>
                            
                            <div className="bg-surfaceLight p-4 rounded-2xl border border-white/10 mb-6">
                                <h3 className="text-sm font-bold text-primary uppercase mb-4">Add New Service</h3>
                                <div className="space-y-3">
                                    <input value={newSvcName} onChange={e=>setNewSvcName(e.target.value)} placeholder="Service Name (e.g. Haircut)" className="w-full bg-bg p-3 rounded-lg border border-white/10 text-white outline-none focus:border-primary" />
                                    <div className="flex gap-2">
                                        <input value={newSvcPrice} onChange={e=>setNewSvcPrice(e.target.value)} type="number" placeholder="Price (‚Çπ)" className="w-1/2 bg-bg p-3 rounded-lg border border-white/10 text-white outline-none focus:border-primary" />
                                        <input value={newSvcTime} onChange={e=>setNewSvcTime(e.target.value)} type="number" placeholder="Time (min)" className="w-1/2 bg-bg p-3 rounded-lg border border-white/10 text-white outline-none focus:border-primary" />
                                    </div>
                                    <button onClick={addService} className="w-full bg-white text-black font-bold py-3 rounded-lg mt-2">Add Service</button>
                                </div>
                            </div>

                            <div className="space-y-3">
                                {services.map((s, i) => (
                                    <div key={i} className="flex justify-between items-center bg-surfaceLight p-4 rounded-xl border border-white/5">
                                        <div>
                                            <h4 className="font-bold text-white">{s.name}</h4>
                                            <p className="text-xs text-textSec">{s.time} mins</p>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className="font-bold text-primary">‚Çπ{s.price}</span>
                                            <button onClick={()=>deleteService(i)} className="text-danger p-2 hover:bg-danger/10 rounded-lg"><Icon name="trash-2" size={18}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'qr' && (
                        <div className="p-6 pb-24 flex flex-col items-center justify-center h-screen animate-slide-up">
                            <div className="bg-white p-6 rounded-3xl mb-6 shadow-2xl">
                                <div id="qrcode"></div>
                            </div>
                            <h2 className="text-2xl font-bold text-white">{salon?.shopName}</h2>
                            <p className="text-textSec text-sm mb-8">Scan to Join Queue</p>
                            <button onClick={()=> new QRCode(document.getElementById("qrcode"), { text: `https://linefree.app/salon/${user.uid}`, width: 200, height: 200 })} className="px-6 py-3 bg-primary text-black font-bold rounded-xl">Generate QR</button>
                        </div>
                    )}

                    {activeTab === 'profile' && <ProfileScreen user={user} role="Owner" onLogout={onLogout} onSwitchRole={onSwitchRole} />}

                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} role="owner" />
                </div>
            );
        };

        // 5. CUSTOMER DASHBOARD
        const CustomerDashboard = ({ user, onLogout, onSwitchRole }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [salons, setSalons] = useState([]);
            const [favorites, setFavorites] = useState([]);
            const [activeToken, setActiveToken] = useState(null);
            const [userLocation, setUserLocation] = useState(null);
            const [selectedSalon, setSelectedSalon] = useState(null);
            const [selectedServices, setSelectedServices] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                const unsubS = onSnapshot(collection(db, "salons"), s => {
                    const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                    setSalons(data);
                });
                
                // Fetch User Favorites
                const unsubU = onSnapshot(doc(db, "users", user.uid), s => {
                    if (s.exists()) setFavorites(s.data().favorites || []);
                });

                const q = query(collection(db, "tokens"), where("userId", "==", user.uid), where("status", "in", ["waiting", "serving"]));
                const unsubT = onSnapshot(q, s => setActiveToken(!s.empty ? {id:s.docs[0].id, ...s.docs[0].data()} : null));
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        setUserLocation({ lat: position.coords.latitude, lng: position.coords.longitude });
                    });
                }
                return () => { unsubS(); unsubT(); unsubU(); }
            }, [user]);

            useEffect(() => lucide.createIcons(), [activeTab, salons, selectedSalon, favorites]);

            // Sort & Filter Salons
            const processedSalons = React.useMemo(() => {
                let list = salons;
                if (searchQuery) {
                    list = list.filter(s => s.shopName.toLowerCase().includes(searchQuery.toLowerCase()));
                }
                if (!userLocation) return list;
                return list.sort((a, b) => {
                    const distA = a.coordinates ? getDistance(userLocation.lat, userLocation.lng, a.coordinates.lat, a.coordinates.lng) : 9999;
                    const distB = b.coordinates ? getDistance(userLocation.lat, userLocation.lng, b.coordinates.lat, b.coordinates.lng) : 9999;
                    return distA - distB;
                });
            }, [salons, userLocation, searchQuery]);

            const toggleFavorite = async (e, salonId) => {
                e.stopPropagation();
                const userRef = doc(db, "users", user.uid);
                if (favorites.includes(salonId)) {
                    await updateDoc(userRef, { favorites: arrayRemove(salonId) });
                } else {
                    await updateDoc(userRef, { favorites: arrayUnion(salonId) });
                }
            };

            const confirmBooking = async () => {
                if(selectedServices.length === 0) return alert("Please select at least one service.");
                
                const totalDuration = selectedServices.reduce((acc, curr) => acc + curr.time, 0);

                await runTransaction(db, async (t) => {
                    const sRef = doc(db, "salons", selectedSalon.id);
                    const sDoc = await t.get(sRef);
                    const newToken = (sDoc.data().totalTokensToday || 0) + 1;
                    t.update(sRef, { totalTokensToday: newToken });
                    const tRef = doc(collection(db, "tokens"));
                    t.set(tRef, {
                        userId: user.uid, userName: user.displayName, salonId: selectedSalon.id, salonName: selectedSalon.shopName,
                        services: selectedServices,
                        totalDuration: totalDuration,
                        tokenNumber: newToken, status: 'waiting', createdAt: serverTimestamp()
                    });
                });
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                setSelectedSalon(null);
                setSelectedServices([]);
                setActiveTab('activity');
            };

            const toggleService = (service) => {
                if(selectedServices.includes(service)) setSelectedServices(selectedServices.filter(s => s !== service));
                else setSelectedServices([...selectedServices, service]);
            };

            const openMap = (address) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
            };

            const SalonList = ({ list }) => (
                <div className="space-y-4">
                    {list.map(s => {
                        const distance = userLocation && s.coordinates ? getDistance(userLocation.lat, userLocation.lng, s.coordinates.lat, s.coordinates.lng) : null;
                        const isFav = favorites.includes(s.id);
                        return (
                            <div key={s.id} onClick={() => setSelectedSalon(s)} className="bg-surfaceLight p-4 rounded-2xl border border-white/5 flex gap-4 active:scale-[0.98] transition-transform relative">
                                <button onClick={(e) => toggleFavorite(e, s.id)} className="absolute top-4 right-4 z-10 text-white hover:text-danger">
                                    <Icon name="heart" size={20} className={isFav ? "fill-danger text-danger" : ""} />
                                </button>
                                <img src={s.shopImage} className="w-20 h-20 rounded-xl object-cover bg-gray-800" />
                                <div className="flex-1">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-white pr-8">{s.shopName}</h3>
                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${s.status==='open'?'bg-success/10 text-success': s.status==='break' ? 'bg-warning/10 text-warning' : 'bg-danger/10 text-danger'}`}>{s.status}</span>
                                    </div>
                                    <div onClick={(e) => { e.stopPropagation(); openMap(s.address); }} className="text-xs text-gray-400 mt-1 flex items-center gap-1 cursor-pointer hover:text-primary">
                                        <Icon name="map-pin" size={10}/> 
                                        {s.address}
                                        {distance && <span className="text-primary ml-1">({distance} km)</span>}
                                    </div>
                                    <button disabled={s.status!=='open' || activeToken} className="mt-3 bg-white text-black text-xs font-bold py-2.5 w-full rounded-lg hover:bg-primary transition-colors disabled:opacity-50">
                                        {activeToken ? 'Already Booked' : s.status === 'open' ? 'Get Token' : 'Unavailable'}
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                    {list.length === 0 && <div className="text-center py-20 text-textSec">No salons found.</div>}
                </div>
            );

            // RENDER
            return (
                <div className="min-h-screen bg-bg">
                    {/* BOOKING MODAL */}
                    {selectedSalon && (
                        <div className="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-end sm:items-center justify-center p-4 animate-slide-up">
                            <div className="w-full max-w-md bg-surfaceLight border border-white/10 rounded-3xl p-6 relative">
                                <button onClick={()=>setSelectedSalon(null)} className="absolute top-4 right-4 text-textSec"><Icon name="x"/></button>
                                <h2 className="text-xl font-bold text-white mb-1">{selectedSalon.shopName}</h2>
                                <p className="text-textSec text-sm mb-6">Select Services</p>
                                
                                <div className="space-y-3 mb-6 max-h-60 overflow-y-auto">
                                    {selectedSalon.services?.map((s, i) => (
                                        <div key={i} onClick={()=>toggleService(s)} className={`p-4 rounded-xl border flex justify-between items-center cursor-pointer transition-all ${selectedServices.includes(s) ? 'bg-primary/20 border-primary text-white' : 'bg-surface border-white/5 text-textSec'}`}>
                                            <div>
                                                <div className="font-bold">{s.name}</div>
                                                <div className="text-xs opacity-60">‚Çπ{s.price} ‚Ä¢ {s.time} min</div>
                                            </div>
                                            {selectedServices.includes(s) && <Icon name="check-circle" size={18} className="text-primary"/>}
                                        </div>
                                    ))}
                                    {(!selectedSalon.services || selectedSalon.services.length === 0) && <p className="text-center text-textSec">No services available.</p>}
                                </div>

                                <div className="flex justify-between items-center py-4 border-t border-white/10 mb-4">
                                    <div className="text-left">
                                        <span className="text-xs text-textSec block">Total Time</span>
                                        <span className="text-sm font-bold text-white">{selectedServices.reduce((a, b) => a + b.time, 0)} min</span>
                                    </div>
                                    <div className="text-right">
                                        <span className="text-xs text-textSec block">Total Cost</span>
                                        <span className="text-xl font-bold text-white">‚Çπ{selectedServices.reduce((a, b) => a + b.price, 0)}</span>
                                    </div>
                                </div>
                                <div className="bg-warning/10 text-warning text-xs p-3 rounded-lg mb-4 text-center">
                                    ‚ö†Ô∏è Please arrive 10 minutes before your turn.
                                </div>
                                <button onClick={confirmBooking} className="w-full bg-primary text-black font-bold py-4 rounded-xl">Confirm Booking</button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'home' && (
                        <div className="p-6 pb-24">
                            <div className="flex justify-between items-center mb-6 sticky top-0 bg-bg z-20 py-4 border-b border-white/5">
                                <h1 className="text-xl font-bold text-white">Line Free <span className="text-primary">India</span></h1>
                                <img src={user.photoURL} className="w-8 h-8 rounded-full border border-primary/50" />
                            </div>
                            
                            <div className="relative mb-6">
                                <Icon name="search" className="absolute left-4 top-3.5 text-textSec" size={20} />
                                <input value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} placeholder="Search salons..." className="w-full bg-surfaceLight border border-white/5 rounded-2xl py-3 pl-12 pr-4 text-white focus:border-primary outline-none" />
                            </div>

                            <h2 className="text-lg font-bold text-white mb-4">Nearby Salons</h2>
                            <SalonList list={processedSalons} />
                        </div>
                    )}

                    {activeTab === 'favorites' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Favorite Salons</h2>
                            <SalonList list={salons.filter(s => favorites.includes(s.id))} />
                        </div>
                    )}

                    {activeTab === 'activity' && (
                        <div className="p-6 pb-24 animate-slide-up">
                            <h2 className="text-2xl font-bold text-white mb-6">Activity</h2>
                            {activeToken ? (
                                <div className="bg-surfaceLight border border-primary/40 p-6 rounded-[2rem] mb-8 relative overflow-hidden animate-slide-up shadow-[0_0_20px_rgba(255,215,0,0.1)]">
                                    <div className="text-center">
                                        <p className="text-xs text-primary font-bold uppercase tracking-widest mb-1 animate-pulse">Live Status</p>
                                        <h1 className="text-6xl font-black text-white tracking-tighter">{activeToken.tokenNumber}</h1>
                                        <p className="text-gray-400 mt-1 text-sm">{activeToken.salonName}</p>
                                        
                                        <div className="flex justify-between mt-6 pt-6 border-t border-white/10">
                                            <div className="text-center">
                                                <p className="text-2xl font-bold text-white">3</p>
                                                <p className="text-[10px] text-textSec uppercase">Ahead</p>
                                            </div>
                                            <div className="text-center">
                                                {/* Mock Wait Time Calculation */}
                                                <p className="text-2xl font-bold text-primary">~{activeToken.totalDuration || 30}m</p>
                                                <p className="text-[10px] text-textSec uppercase">Est Wait</p>
                                            </div>
                                        </div>

                                        <button onClick={()=>updateDoc(doc(db, "tokens", activeToken.id), {status: 'cancelled'})} className="mt-6 text-danger text-xs font-bold border border-danger/20 px-4 py-2 rounded-lg hover:bg-danger/10">Cancel Token</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center py-20 text-textSec">No active bookings.</div>
                            )}
                        </div>
                    )}

                    {activeTab === 'subscription' && <SubscriptionScreen />}

                    {activeTab === 'profile' && <ProfileScreen user={user} role="Customer" onLogout={onLogout} onSwitchRole={onSwitchRole} />}

                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} role="customer" />
                </div>
            );
        };

        // 5. LOGIN & ROLE
        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen bg-bg p-6 flex flex-col justify-end pb-16">
                <div className="mb-10 animate-slide-up">
                    <div className="w-16 h-16 rounded-2xl glass border border-primary/20 flex items-center justify-center mb-6">
                        <Icon name="crown" size={32} className="text-primary" />
                    </div>
                    <h1 className="text-5xl font-bold text-white mb-2 leading-tight">Ready.<br/><span className="text-primary">Set. Go.</span></h1>
                    <p className="text-textSec text-lg">Queue Less. Live More.</p>
                </div>
                <button onClick={onLogin} className="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition-transform active:scale-95 shadow-xl hover:bg-gray-100 animate-slide-up">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6"/>
                    Continue with Google
                </button>
            </div>
        );

        const RoleSelection = ({ onSelect }) => (
            <div className="min-h-screen bg-bg p-6 pt-24 animate-slide-up">
                <h2 className="text-3xl font-bold text-white mb-2">Who are you?</h2>
                <div className="space-y-4 mt-8">
                    <button onClick={() => onSelect('customer')} className="w-full bg-surfaceLight p-6 rounded-2xl border border-white/5 flex items-center gap-5 hover:border-primary/50 transition-all text-left">
                        <div className="w-12 h-12 bg-surface rounded-full flex items-center justify-center text-white border border-white/5"><Icon name="user" size={24} /></div>
                        <div>
                            <h3 className="text-lg font-bold text-white">Customer</h3>
                            <p className="text-textSec text-xs mt-1">Book services instantly.</p>
                        </div>
                    </button>
                    <button onClick={() => onSelect('owner')} className="w-full bg-surfaceLight p-6 rounded-2xl border border-white/5 flex items-center gap-5 hover:border-primary/50 transition-all text-left">
                        <div className="w-12 h-12 bg-surface rounded-full flex items-center justify-center text-white border border-white/5"><Icon name="store" size={24} /></div>
                        <div>
                            <h3 className="text-lg font-bold text-white">Salon Owner</h3>
                            <p className="text-textSec text-xs mt-1">Manage your business.</p>
                        </div>
                    </button>
                </div>
            </div>
        );

        // --- ROOT APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if (u) {
                        const snap = await getDoc(doc(db, "users", u.uid));
                        if (snap.exists()) setRole(snap.data().role);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleLogin = () => signInWithPopup(auth, googleProvider);
            const handleRoleSelect = async (r) => {
                await setDoc(doc(db, "users", user.uid), { role: r, email: user.email, name: user.displayName, photoURL: user.photoURL, createdAt: serverTimestamp() });
                setRole(r);
            };
            const handleLogout = () => signOut(auth);
            
            const switchRole = async () => {
                if(confirm("Switch profile? You will need to select again.")) {
                    await deleteDoc(doc(db, "users", user.uid));
                    setRole(null);
                }
            };

            if (loading) return (
                <div className="fixed inset-0 z-50 bg-black flex items-center justify-center">
                    <div className="text-primary font-bold text-2xl tracking-widest animate-pulse">LINE FREE</div>
                </div>
            );

            return !user ? <LoginScreen onLogin={handleLogin} /> : 
                   !role ? <RoleSelection onSelect={handleRoleSelect} /> : 
                   role === 'owner' ? <OwnerDashboard user={user} onLogout={handleLogout} onSwitchRole={switchRole} /> : <CustomerDashboard user={user} onLogout={handleLogout} onSwitchRole={switchRole} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
